@page "/import-export"
@inject IImportExportService ImportExportService
@inject IImportPresetService ImportPresetService
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Import/Export - NonProfit Finance</PageTitle>

<div class="d-flex justify-between align-center mb-3">
    <div>
        <h2 style="margin: 0;">Import & Export</h2>
        <p class="text-muted">Import transactions from CSV or export your data</p>
    </div>
</div>

<div class="charts-grid">
    <!-- Import Section -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title"><i class="fas fa-file-import"></i> Import Data</h3>
        </div>
        <div class="card-body">
            <div class="tabs mb-3">
                <div class="tab @(importTab == "transactions" ? "active" : "")" 
                     @onclick="SetTransactionsTab">
                    Transactions
                </div>
                <div class="tab @(importTab == "donors" ? "active" : "")" 
                     @onclick="SetDonorsTab">
                    Donors
                </div>
            </div>
            
            <!-- Preset Selection -->
            <div class="form-row mb-3" style="background: var(--bg-secondary); padding: 0.75rem; border-radius: 8px;">
                <div class="form-group" style="flex: 1;">
                    <label class="form-label"><i class="fas fa-bookmark"></i> Load Preset</label>
                    <select class="form-control" @onchange="OnPresetSelected">
                        <option value="">-- Select a saved preset --</option>
                        @foreach (var preset in savedPresets)
                        {
                            <option value="@preset.Id">
                                @preset.Name @(preset.IsDefault ? "‚≠ê" : "") 
                                @(!string.IsNullOrEmpty(preset.Description) ? $"({preset.Description})" : "")
                            </option>
                        }
                    </select>
                </div>
                <div class="form-group" style="align-self: flex-end;">
                    <button class="btn btn-outline btn-sm" @onclick="ShowSavePresetModal" title="Save current settings as preset">
                        <i class="fas fa-save"></i> Save Preset
                    </button>
                    @if (selectedPresetId.HasValue)
                    {
                        <button class="btn btn-outline btn-sm text-danger" @onclick="DeleteSelectedPreset" title="Delete selected preset">
                            <i class="fas fa-trash"></i>
                        </button>
                    }
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Select CSV File</label>
                <InputFile OnChange="HandleFileSelected" class="form-control" accept=".csv" />
            </div>
            
            @if (selectedFile != null)
            {
                <div class="alert alert-info">
                    <i class="fas fa-file-csv"></i>
                    Selected: @selectedFile.Name (@(selectedFile.Size / 1024) KB)
                </div>
                
                <div class="form-group">
                    <label class="d-flex align-center gap-2">
                        <input type="checkbox" @bind="hasHeaderRow" />
                        File has header row
                    </label>
                </div>
                
                <h4>Column Mapping</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Date Column</label>
                        <input type="number" class="form-control" @bind="dateColumn" min="0" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount Column</label>
                        <input type="number" class="form-control" @bind="amountColumn" min="0" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description Column</label>
                        <input type="number" class="form-control" @bind="descriptionColumn" min="0" />
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Type Column (optional)</label>
                        <input type="number" class="form-control" @bind="typeColumn" min="0" placeholder="e.g., 3" />
                        <small class="text-muted">Column with Income/Expense/Transfer</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category Column (optional)</label>
                        <input type="number" class="form-control" @bind="categoryColumn" min="0" />
                        <small class="text-muted">Name of category</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Account Column (optional)</label>
                        <input type="number" class="form-control" @bind="fundColumn" min="0" />
                        <small class="text-muted">Name of fund/account</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Donor Column (optional)</label>
                        <input type="number" class="form-control" @bind="donorColumn" min="0" />
                        <small class="text-muted">Donor name for income transactions</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Payee Column (optional)</label>
                        <input type="number" class="form-control" @bind="payeeColumn" min="0" />
                        <small class="text-muted">Who received/paid the money</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date Format</label>
                        <select class="form-control" @bind="dateFormat">
                            <option value="yyyy-MM-dd">yyyy-MM-dd</option>
                            <option value="MM/dd/yyyy">MM/dd/yyyy</option>
                            <option value="dd/MM/yyyy">dd/MM/yyyy</option>
                            <option value="M/d/yyyy">M/d/yyyy</option>
                        </select>
                    </div>
                </div>
                
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-outline" @onclick="PreviewImport" disabled="@isProcessing">
                        <i class="fas fa-eye"></i> Preview
                    </button>
                    <button class="btn btn-primary" @onclick="ExecuteImport" disabled="@isProcessing">
                        @if (isProcessing)
                        {
                            <span class="spinner"></span>
                        }
                        else
                        {
                            <i class="fas fa-upload"></i>
                        }
                        Import
                    </button>
                </div>
            }
            
            @* Progress Bar *@
            @if (isProcessing && importProgress != null)
            {
                <div class="mt-3" style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; border: 2px solid var(--primary-color);">
                    <div class="d-flex justify-between mb-1">
                        <span class="text-muted" style="font-weight: 600;">
                            <i class="fas fa-spinner fa-spin"></i> Processing row @importProgress.CurrentRow of @importProgress.TotalRows
                        </span>
                        <span class="text-muted" style="font-weight: 600; font-size: 1.1rem;">@GetProgressPercentage()%</span>
                    </div>
                    <div class="progress" style="height: 24px; border: 1px solid var(--border-color); border-radius: 8px;">
                        <div class="progress-bar" 
                             role="progressbar" 
                             style="width: @GetProgressPercentage()%; background: linear-gradient(90deg, var(--primary-color), var(--color-primary-light)); transition: width 0.3s ease;"
                             aria-valuenow="@GetProgressPercentage()" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            <span style="padding-left: 0.5rem; color: white; font-weight: 600; line-height: 24px;">
                                @if (GetProgressPercentage() > 15)
                                {
                                    <text>@GetProgressPercentage()%</text>
                                }
                            </span>
                        </div>
                    </div>
                    <div class="d-flex gap-3 mt-2" style="font-size: 0.9rem;">
                        <span class="text-success" style="font-weight: 600;">
                            <i class="fas fa-check-circle"></i> Imported: @importProgress.ImportedCount
                        </span>
                        <span class="text-warning" style="font-weight: 600;">
                            <i class="fas fa-exclamation-triangle"></i> Skipped: @importProgress.SkippedCount
                        </span>
                    </div>
                    @if (!string.IsNullOrEmpty(importProgress.CurrentDescription))
                    {
                        <small class="text-muted d-block mt-2" style="font-style: italic;">
                            <i class="fas fa-file-alt"></i> @importProgress.CurrentDescription
                        </small>
                    }
                </div>
            }
            
            @if (importResult != null)
            {
                <div class="alert @(importResult.Success ? "alert-success" : "alert-warning") mt-3">
                    <strong>Import Complete:</strong>
                    <ul style="margin: 0.5rem 0 0 1rem;">
                        <li>Imported: @importResult.ImportedRows rows</li>
                        <li>Skipped: @importResult.SkippedRows rows</li>
                        @if (importResult.Errors.Any())
                        {
                            <li>Errors: @importResult.Errors.Count</li>
                        }
                    </ul>
                    @if (importResult.Errors.Any())
                    {
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-sm btn-primary" @onclick="DownloadSkippedRows">
                                <i class="fas fa-file-excel"></i> Download Skipped Rows (For Correction)
                            </button>
                            <button class="btn btn-sm btn-outline" @onclick="DownloadErrorSummary">
                                <i class="fas fa-list"></i> Download Error Summary
                            </button>
                        </div>
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-info-circle"></i> 
                            <strong>Skipped Rows:</strong> Contains original data with error notes - fix and re-import.<br />
                            <strong>Error Summary:</strong> Detailed error report for review.
                        </small>
                    }
                </div>
            }
            
            @if (previewResult != null)
            {
                var validRows = previewResult.Transactions.Where(t => t.IsValid).ToList();
                var invalidRows = previewResult.Transactions.Where(t => !t.IsValid).ToList();
                
                <div class="mt-3">
                    <h4>Preview (@validRows.Count valid, @invalidRows.Count invalid)</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var row in validRows.Take(5))
                            {
                                <tr>
                                    <td>@row.Date?.ToString("MM/dd/yyyy")</td>
                                    <td>@row.Amount?.ToString("C")</td>
                                    <td>@row.Description</td>
                                    <td>@row.Category</td>
                                    <td><span class="badge badge-success">Valid</span></td>
                                </tr>
                            }
                            @foreach (var row in invalidRows.Take(3))
                            {
                                <tr class="text-muted">
                                    <td colspan="4">@string.Join(", ", row.Errors)</td>
                                    <td><span class="badge badge-danger">Invalid</span></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
    
    <!-- Export Section -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title"><i class="fas fa-file-export"></i> Export Data</h3>
        </div>
        <div class="card-body">
            <!-- Excel Export with Data Selection -->
            <h4>Excel Export (Select Data)</h4>
            <p class="text-muted" style="font-size: 0.9rem;">Choose which data to include in your Excel export</p>
            
            <div class="form-group">
                <label class="d-flex align-center gap-2">
                    <input type="checkbox" @bind="exportTransactions" />
                    <strong>Transactions</strong>
                </label>
                @if (exportTransactions)
                {
                    <div style="margin-left: 1.5rem; margin-top: 0.5rem;">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control" @bind="exportStartDate" />
                            </div>
                            <div class="form-group">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-control" @bind="exportEndDate" />
                            </div>
                        </div>
                    </div>
                }
            </div>
            
            <div class="form-group">
                <label class="d-flex align-center gap-2">
                    <input type="checkbox" @bind="exportCategories" />
                    <strong>Categories</strong>
                </label>
            </div>
            
            <div class="form-group">
                <label class="d-flex align-center gap-2">
                    <input type="checkbox" @bind="exportDonors" />
                    <strong>Donors</strong>
                </label>
            </div>
            
            <div class="form-group">
                <label class="d-flex align-center gap-2">
                    <input type="checkbox" @bind="exportGrants" />
                    <strong>Grants</strong>
                </label>
            </div>
            
            <div class="form-group">
                <label class="d-flex align-center gap-2">
                    <input type="checkbox" @bind="exportFunds" />
                    <strong>Funds</strong>
                </label>
            </div>
            
            <button class="btn btn-primary" @onclick="ExportToExcel" disabled="@(!CanExportExcel)">
                <i class="fas fa-file-excel"></i> Export to Excel
            </button>
            
            @if (!CanExportExcel && (exportTransactions || exportCategories || exportDonors || exportGrants || exportFunds))
            {
                <small class="text-muted d-block mt-2">Select at least one data type to export</small>
            }
            
            <hr style="margin: 1.5rem 0;" />
            
            <h4>Quick CSV Exports</h4>
            <p class="text-muted" style="font-size: 0.9rem;">Export individual data types to CSV</p>
            <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-outline" @onclick="ExportTransactionsCsv">
                    <i class="fas fa-exchange-alt"></i> Transactions CSV
                </button>
                <button class="btn btn-outline" @onclick="ExportCategoriesCsv">
                    <i class="fas fa-tags"></i> Categories CSV
                </button>
                <button class="btn btn-outline" @onclick="ExportDonorsCsv">
                    <i class="fas fa-heart"></i> Donors CSV
                </button>
                <button class="btn btn-outline" @onclick="ExportGrantsCsv">
                    <i class="fas fa-hand-holding-usd"></i> Grants CSV
                </button>
            </div>
            
            <hr style="margin: 1.5rem 0;" />
            
            <h4>Download Templates</h4>
            <div class="d-flex flex-wrap gap-2">
                <a href="/api/importexport/templates/transactions" class="btn btn-outline" target="_blank">
                    <i class="fas fa-file-csv"></i> Transaction Template
                </a>
                <a href="/api/importexport/templates/donors" class="btn btn-outline" target="_blank">
                    <i class="fas fa-file-csv"></i> Donor Template
                </a>
            </div>
        </div>
    </div>
</div>

@* Save Preset Modal *@
@if (showSavePresetModal)
{
    <div class="modal-backdrop" @onclick="CloseSavePresetModal">
        <div class="modal" @onclick:stopPropagation="true" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-bookmark"></i> Save Import Preset</h3>
                <button class="modal-close" @onclick="CloseSavePresetModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Preset Name *</label>
                    <input type="text" class="form-control" @bind="newPresetName" 
                           placeholder="e.g., QuickBooks Export, Bank of America CSV" />
                </div>
                <div class="form-group">
                    <label class="form-label">Description (optional)</label>
                    <input type="text" class="form-control" @bind="newPresetDescription" 
                           placeholder="e.g., Monthly export from QuickBooks Online" />
                </div>
                <div class="form-group">
                    <label class="d-flex align-center gap-2">
                        <input type="checkbox" @bind="newPresetIsDefault" />
                        Set as default preset
                    </label>
                    <small class="text-muted">Default preset loads automatically when opening this page</small>
                </div>
                
                <div class="alert alert-info mt-3" style="font-size: 0.85rem;">
                    <strong>Settings to be saved:</strong>
                    <ul style="margin: 0.5rem 0 0 1rem; padding: 0;">
                        <li>Date Column: @dateColumn</li>
                        <li>Amount Column: @amountColumn</li>
                        <li>Description Column: @descriptionColumn</li>
                        @if (typeColumn.HasValue) { <li>Type Column: @typeColumn</li> }
                        @if (categoryColumn.HasValue) { <li>Category Column: @categoryColumn</li> }
                        @if (fundColumn.HasValue) { <li>Account Column: @fundColumn</li> }
                        @if (donorColumn.HasValue) { <li>Donor Column: @donorColumn</li> }
                        @if (payeeColumn.HasValue) { <li>Payee Column: @payeeColumn</li> }
                        <li>Has Header Row: @(hasHeaderRow ? "Yes" : "No")</li>
                        <li>Date Format: @dateFormat</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" @onclick="CloseSavePresetModal">Cancel</button>
                <button class="btn btn-primary" @onclick="SavePreset" disabled="@string.IsNullOrWhiteSpace(newPresetName)">
                    <i class="fas fa-save"></i> Save Preset
                </button>
            </div>
        </div>
    </div>
}

@code {
private string importTab = "transactions";
private IBrowserFile? selectedFile;
private bool hasHeaderRow = true;
private int dateColumn = 0;
private int amountColumn = 1;
private int descriptionColumn = 2;
private int? typeColumn = 3; // Default to column 3 (Type in exported CSV)
private int? categoryColumn = 4; // Default to column 4 (Category in exported CSV)
private int? fundColumn = 5; // Default to column 5 (Fund/Account in exported CSV)
private int? donorColumn = null; // Donor column (optional)
private int? payeeColumn = null; // Payee column (optional)
private string dateFormat = "yyyy-MM-dd";
private bool isProcessing = false;
private ImportProgress? importProgress;

// Preset management
private List<ImportPreset> savedPresets = new();
private int? selectedPresetId = null;
private bool showSavePresetModal = false;
private string newPresetName = "";
private string newPresetDescription = "";
private bool newPresetIsDefault = false;
    
private DateTime exportStartDate = DateTime.Today.AddMonths(-1);
private DateTime exportEndDate = DateTime.Today;

// Excel export selections
private bool exportTransactions = true;
private bool exportCategories = false;
private bool exportDonors = false;
private bool exportGrants = false;
private bool exportFunds = false;

private bool CanExportExcel => exportTransactions || exportCategories || exportDonors || exportGrants || exportFunds;
    
private ImportResult? importResult;
private ImportPreviewResult? previewResult;
private ImportMappingConfig? lastMappingConfig; // Store for error report generation

protected override async Task OnInitializedAsync()
{
    await LoadPresetsAsync();
    await LoadDefaultPresetAsync();
}

private void SetTransactionsTab() => importTab = "transactions";
private void SetDonorsTab() => importTab = "donors";

private void HandleFileSelected(InputFileChangeEventArgs e)
{
    selectedFile = e.File;
    importResult = null;
    previewResult = null;
}

private async Task PreviewImport()
{
    if (selectedFile == null) return;

    isProcessing = true;
    previewResult = null;
    await InvokeAsync(StateHasChanged);
    
    try
    {
            using var stream = selectedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            memoryStream.Position = 0;

            var mapping = new ImportMappingConfig(
                dateColumn, amountColumn, descriptionColumn,
                categoryColumn, fundColumn, donorColumn, null, typeColumn,
                payeeColumn, null, hasHeaderRow, dateFormat);

            previewResult = await ImportExportService.PreviewImportAsync(memoryStream, mapping);
        }
        finally
        {
            isProcessing = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task ExecuteImport()
    {
        if (selectedFile == null) return;

        isProcessing = true;
        importResult = null;
        importProgress = null;
        await InvokeAsync(StateHasChanged);
        
        try
        {
            using var stream = selectedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            memoryStream.Position = 0;

            var mapping = new ImportMappingConfig(
                dateColumn, amountColumn, descriptionColumn,
                categoryColumn, fundColumn, donorColumn, null, typeColumn,
                payeeColumn, null, hasHeaderRow, dateFormat);

            // Store mapping for error report generation
            lastMappingConfig = mapping;

            // Create progress reporter that updates UI
            var progress = new Progress<ImportProgress>(async p =>
            {
                importProgress = p;
                // Update UI every 5 rows or at completion for better visibility
                if (p.CurrentRow % 5 == 0 || p.CurrentRow == p.TotalRows || p.CurrentRow == 1)
                {
                    await InvokeAsync(StateHasChanged);
                }
            });

            importResult = await ImportExportService.ImportTransactionsFromCsvAsync(memoryStream, mapping, progress);
            
            // Clear preview after successful import
            if (importResult.Success || importResult.ImportedRows > 0)
            {
                previewResult = null;
            }
        }
        catch (Exception ex)
        {
            importResult = new ImportResult(
                false, 0, 0, 0,
                new List<ImportError> { new ImportError(0, "Import", ex.Message) },
                new List<string>()
            );
        }
        finally
        {
            isProcessing = false;
            importProgress = null;
            await InvokeAsync(StateHasChanged);
        }
    }

    private int GetProgressPercentage()
    {
        if (importProgress == null || importProgress.TotalRows == 0) return 0;
        return (int)((double)importProgress.CurrentRow / importProgress.TotalRows * 100);
    }

    private async Task DownloadSkippedRows()
    {
        if (importResult == null || !importResult.Errors.Any() || lastMappingConfig == null) return;
        
        var csv = ImportExportService.GenerateSkippedRowsCsv(importResult, lastMappingConfig);
        await DownloadFile(csv, $"skipped_rows_to_fix_{DateTime.Now:yyyyMMdd_HHmmss}.csv", "text/csv");
    }

    private async Task DownloadErrorSummary()
    {
        if (importResult == null || !importResult.Errors.Any() || lastMappingConfig == null) return;
        
        var csv = ImportExportService.GenerateErrorRowsCsv(importResult, lastMappingConfig);
        await DownloadFile(csv, $"error_summary_{DateTime.Now:yyyyMMdd_HHmmss}.csv", "text/csv");
    }

    private async Task DownloadErrorReport()
    {
        if (importResult == null || !importResult.Errors.Any()) return;
        
        var csv = ImportExportService.GenerateErrorReportCsv(importResult);
        await DownloadFile(csv, $"import_errors_{DateTime.Now:yyyyMMdd_HHmmss}.csv", "text/csv");
    }

    private async Task ExportToExcel()
    {
        if (!CanExportExcel) return;

        var excel = await ImportExportService.ExportToExcelAsync(
            exportTransactions ? new TransactionFilterRequest(exportStartDate, exportEndDate) : null,
            exportCategories,
            exportDonors,
            exportGrants,
            exportFunds
        );
        await DownloadFile(excel, $"nonprofit_data_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
    }

    private async Task ExportTransactionsCsv()
    {
        var filter = new TransactionFilterRequest(exportStartDate, exportEndDate);
        var csv = await ImportExportService.ExportTransactionsToCsvAsync(filter);
        await DownloadFile(csv, $"transactions_{DateTime.Now:yyyyMMdd}.csv", "text/csv");
    }

    private async Task ExportCategoriesCsv()
    {
        var csv = await ImportExportService.ExportCategoriesToCsvAsync();
        await DownloadFile(csv, $"categories_{DateTime.Now:yyyyMMdd}.csv", "text/csv");
    }

    private async Task ExportDonorsCsv()
    {
        var csv = await ImportExportService.ExportDonorsToCsvAsync();
        await DownloadFile(csv, $"donors_{DateTime.Now:yyyyMMdd}.csv", "text/csv");
    }

    private async Task ExportGrantsCsv()
    {
        var csv = await ImportExportService.ExportGrantsToCsvAsync();
        await DownloadFile(csv, $"grants_{DateTime.Now:yyyyMMdd}.csv", "text/csv");
    }

    private async Task DownloadFile(byte[] content, string fileName, string contentType)
    {
        var base64 = Convert.ToBase64String(content);
        await JS.InvokeVoidAsync("downloadFile", fileName, contentType, base64);
    }

    // ========== Preset Management ==========

    private async Task LoadPresetsAsync()
    {
        savedPresets = await ImportPresetService.GetAllAsync(importTab);
    }

    private async Task LoadDefaultPresetAsync()
    {
        var defaultPreset = await ImportPresetService.GetDefaultAsync(importTab);
        if (defaultPreset != null)
        {
            ApplyPreset(defaultPreset);
            selectedPresetId = defaultPreset.Id;
        }
    }

    private async Task OnPresetSelected(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var presetId))
        {
            var preset = await ImportPresetService.GetByIdAsync(presetId);
            if (preset != null)
            {
                ApplyPreset(preset);
                selectedPresetId = presetId;
                await ImportPresetService.UpdateLastUsedAsync(presetId);
            }
        }
        else
        {
            selectedPresetId = null;
        }
    }

    private void ApplyPreset(ImportPreset preset)
    {
        dateColumn = preset.DateColumn;
        amountColumn = preset.AmountColumn;
        descriptionColumn = preset.DescriptionColumn;
        typeColumn = preset.TypeColumn;
        categoryColumn = preset.CategoryColumn;
        fundColumn = preset.FundColumn;
        donorColumn = preset.DonorColumn;
        payeeColumn = preset.PayeeColumn;
        hasHeaderRow = preset.HasHeaderRow;
        dateFormat = preset.DateFormat;
        StateHasChanged();
    }

    private void ShowSavePresetModal()
    {
        newPresetName = "";
        newPresetDescription = "";
        newPresetIsDefault = false;
        showSavePresetModal = true;
    }

    private void CloseSavePresetModal()
    {
        showSavePresetModal = false;
    }

    private async Task SavePreset()
    {
        if (string.IsNullOrWhiteSpace(newPresetName)) return;

        var preset = new ImportPreset
        {
            Name = newPresetName.Trim(),
            Description = string.IsNullOrWhiteSpace(newPresetDescription) ? null : newPresetDescription.Trim(),
            ImportType = importTab,
            DateColumn = dateColumn,
            AmountColumn = amountColumn,
            DescriptionColumn = descriptionColumn,
            TypeColumn = typeColumn,
            CategoryColumn = categoryColumn,
            FundColumn = fundColumn,
            DonorColumn = donorColumn,
            PayeeColumn = payeeColumn,
            HasHeaderRow = hasHeaderRow,
            DateFormat = dateFormat,
            IsDefault = newPresetIsDefault
        };

        await ImportPresetService.CreateAsync(preset);
        await LoadPresetsAsync();
        CloseSavePresetModal();
        
        // Show success message (optional - could add a toast)
        StateHasChanged();
    }

    private async Task DeleteSelectedPreset()
    {
        if (!selectedPresetId.HasValue) return;

        await ImportPresetService.DeleteAsync(selectedPresetId.Value);
        selectedPresetId = null;
        await LoadPresetsAsync();
    }
}
