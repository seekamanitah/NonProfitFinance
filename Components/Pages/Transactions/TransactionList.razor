@page "/transactions"
@using System.Web
@implements IDisposable
@inject ITransactionService TransactionService
@inject ICategoryService CategoryService
@inject IFundService FundService
@inject IDonorService DonorService
@inject IGrantService GrantService
@inject ITextToSpeechService TtsService
@inject IToastService Toast
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Transactions - NonProfit Finance</PageTitle>

<div class="d-flex justify-between align-center mb-3 flex-wrap gap-2">
    <div>
        <h2 style="margin: 0;">Transactions</h2>
    </div>
    <div class="d-flex gap-2 flex-wrap">
        <a href="/transactions/duplicates" class="btn btn-outline btn-sm" title="Find duplicate transactions">
            <i class="fas fa-clone"></i> <span class="hide-mobile">Duplicates</span>
        </a>
        <a href="/transactions/recycle-bin" class="btn btn-outline btn-sm" title="View deleted transactions">
            <i class="fas fa-trash-restore"></i> <span class="hide-mobile">Recycle Bin</span>
        </a>
        <a href="/transactions/recurring" class="btn btn-outline btn-sm">
            <i class="fas fa-sync-alt"></i> <span class="hide-mobile">Recurring</span>
        </a>
        <button class="btn btn-primary" @onclick="ShowAddForm">
            <i class="fas fa-plus"></i> Add
        </button>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar @(isFiltering ? "filtering" : "")">
    <div class="filter-group">
        <span class="filter-label">Date Range</span>
        <div class="d-flex gap-2">
            <input type="date" class="form-control" @bind="filter.StartDate" @bind:after="OnDateChanged" style="width: 140px;" />
            <span>to</span>
            <input type="date" class="form-control" @bind="filter.EndDate" @bind:after="OnDateChanged" style="width: 140px;" />
        </div>
    </div>
    
    <div class="filter-group">
        <span class="filter-label">Category</span>
        <select class="form-control" value="@filter.CategoryId" @onchange="OnCategoryChanged" style="width: 180px;">
            <option value="">All Categories</option>
            @foreach (var cat in categories)
            {
                <option value="@cat.Id">@cat.Name</option>
            }
        </select>
    </div>
    
    <div class="filter-group">
        <span class="filter-label">Account</span>
        <select class="form-control" value="@filter.FundId" @onchange="OnFundChanged" style="width: 160px;">
            <option value="">All Accounts</option>
            @foreach (var fund in funds)
            {
                <option value="@fund.Id">@fund.Name</option>
            }
        </select>
    </div>
    
    <div class="filter-group">
        <span class="filter-label">Type</span>
        <select class="form-control" value="@filter.Type" @onchange="OnTypeChanged" style="width: 120px;">
            <option value="">All Types</option>
            <option value="@TransactionType.Income">Income</option>
            <option value="@TransactionType.Expense">Expense</option>
            <option value="@TransactionType.Transfer">Transfer</option>
        </select>
    </div>
    
    <div class="filter-group">
        <span class="filter-label">Donor</span>
        <select class="form-control" value="@filter.DonorId" @onchange="OnDonorChanged" style="width: 160px;">
            <option value="">All Donors</option>
            @foreach (var donor in donors)
            {
                <option value="@donor.Id">@donor.Name</option>
            }
        </select>
    </div>
    
    <div class="filter-group">
        <span class="filter-label">Grant</span>
        <select class="form-control" value="@filter.GrantId" @onchange="OnGrantChanged" style="width: 160px;">
            <option value="">All Grants</option>
            @foreach (var grant in grants)
            {
                <option value="@grant.Id">@grant.Name</option>
            }
        </select>
    </div>
    
    <div class="filter-group">
        <span class="filter-label">Tags</span>
        <input type="text" class="form-control" placeholder="e.g., emergency, grant"
               @bind="filter.Tags" @bind:event="oninput" @bind:after="OnTagsChanged" style="width: 150px;" />
    </div>
    
    <div class="filter-group">
        <span class="filter-label">Search</span>
        <input type="text" class="form-control" placeholder="Description, payee..." 
               @bind="filter.SearchTerm" @bind:event="oninput" @bind:after="OnSearchTermChanged" 
               style="width: 180px;" aria-label="Search transactions" />
    </div>
    
    <div class="filter-group">
        <label class="d-flex align-center gap-2" style="margin-bottom: 0; white-space: nowrap;">
            <input type="checkbox" checked="@filter.UnreconciledOnly" @onchange="OnReconciledFilterChanged" />
            Unreconciled Only
        </label>
    </div>
    
    <div class="filter-group" style="align-self: flex-end;">
        <button class="btn btn-secondary" @onclick="ClearFilters" disabled="@(!HasActiveFilters)">
            <i class="fas fa-times"></i> Clear
        </button>
        @if (isFiltering)
        {
            <span class="spinner" style="width: 16px; height: 16px; margin-left: 8px;"></span>
        }
    </div>
</div>

<!-- Batch Action Bar -->
@if (selectedTransactionIds.Count > 0)
{
    <div class="alert alert-info d-flex justify-between align-center mb-3 batch-action-bar">
        <span><strong>@selectedTransactionIds.Count</strong> transaction(s) selected</span>
        <div class="d-flex gap-2">
            <button class="btn btn-outline btn-sm" @onclick="DeselectAll">
                <i class="fas fa-times"></i> Deselect All
            </button>
            <button class="btn btn-outline btn-sm text-danger" @onclick="ShowBatchDeleteConfirm">
                <i class="fas fa-trash"></i> Delete Selected
            </button>
        </div>
    </div>
}

<!-- Actions Bar - count shown in pagination below -->



<!-- Transactions Table -->
<div class="card">
    <div class="card-body" style="padding: 0; overflow-x: auto;">
        @if (isLoading)
        {
            <SkeletonLoader Type="SkeletonLoader.SkeletonType.Table" Rows="10" Columns="7" />
        }
        else
        {
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 30px;">
                            <input type="checkbox" checked="@isAllSelected" @onchange="ToggleSelectAll" 
                                   title="Select all" aria-label="Select all transactions" />
                        </th>
                        <th style="width: 30px;"></th>
                        <SortableHeader Column="Date" CurrentSort="@sortColumn" CurrentDirection="@sortDirection" OnSort="HandleSort">
                            Date
                        </SortableHeader>
                        <SortableHeader Column="Account" CurrentSort="@sortColumn" CurrentDirection="@sortDirection" OnSort="HandleSort">
                            Account
                        </SortableHeader>
                        <SortableHeader Column="Payee" CurrentSort="@sortColumn" CurrentDirection="@sortDirection" OnSort="HandleSort">
                            Payee/Donor
                        </SortableHeader>
                        <SortableHeader Column="Category" CurrentSort="@sortColumn" CurrentDirection="@sortDirection" OnSort="HandleSort">
                            Category
                        </SortableHeader>
                        <th>Description</th>
                        <SortableHeader Column="Amount" CurrentSort="@sortColumn" CurrentDirection="@sortDirection" OnSort="HandleSort">
                            <span class="text-right">Amount</span>
                        </SortableHeader>
                        <th style="width: 80px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var tx in SortedTransactions)
                    {
                        var hasSplits = tx.Splits?.Any() == true;
                        var isExpanded = expandedTransactions.Contains(tx.Id);
                        
                        <tr>
                            <td>
                                <input type="checkbox" checked="@selectedTransactionIds.Contains(tx.Id)" 
                                       @onchange="() => ToggleSelectTransaction(tx.Id)" 
                                       aria-label="Select transaction" />
                            </td>
                            <td>
                                @if (hasSplits)
                                {
                                    <button class="btn btn-sm btn-icon" @onclick="() => ToggleExpand(tx.Id)" 
                                            style="padding: 0; width: 20px; height: 20px;">
                                        <i class="fas @(isExpanded ? "fa-chevron-down" : "fa-chevron-right")"></i>
                                    </button>
                                }
                            </td>
                            <td>@tx.Date.ToString("MMM dd, yyyy")</td>
                            <td>
                                @if (!string.IsNullOrEmpty(tx.FundName))
                                {
                                    <span class="badge badge-info">@tx.FundName</span>
                                }
                                else
                                {
                                    <span class="text-muted">—</span>
                                }
                            </td>
                            <td>@(tx.DonorName ?? tx.Payee ?? "—")</td>
                            <td>
                                <span class="badge @(tx.Type == TransactionType.Income ? "badge-income" : "badge-expense")">
                                    @tx.CategoryName
                                </span>
                            </td>
                            <td>
                                @(tx.Description ?? "—")
                                @if (tx.IsRecurring)
                                {
                                    <span class="badge badge-info ml-1"><i class="fas fa-sync-alt"></i></span>
                                }
                                @if (hasSplits)
                                {
                                    <span class="badge badge-warning ml-1" title="Split transaction">
                                        <i class="fas fa-code-branch"></i> @tx.Splits!.Count splits
                                    </span>
                                }
                                @if (tx.IsReconciled)
                                {
                                    <span class="badge badge-success ml-1" title="Reconciled">
                                        <i class="fas fa-check-double"></i>
                                    </span>
                                }
                            </td>
                            <td class="text-right amount @(tx.Type == TransactionType.Income ? "income" : "expense")">
                                @(tx.Type == TransactionType.Income ? "+" : "-")@tx.Amount.ToString("C")
                            </td>
                            <td>
                                <div class="d-flex gap-1">
                                    <button class="btn btn-sm btn-outline" @onclick="() => EditTransaction(tx)" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline text-danger" @onclick="() => DeleteTransaction(tx)" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        
                        @* Split details row *@
                        @if (hasSplits && isExpanded)
                        {
                            <tr class="split-details-row" style="background: var(--bg-secondary);">
                                <td colspan="9" style="padding: 0.5rem 1rem;">
                                    <div style="margin-left: 30px;">
                                        <strong class="text-muted">Split Details:</strong>
                                        <table style="width: 100%; margin-top: 0.5rem;">
                                            @foreach (var split in tx.Splits!)
                                            {
                                                <tr style="border-bottom: 1px dashed var(--border-color);">
                                                    <td style="padding: 0.25rem 0;">
                                                        <span class="badge @(tx.Type == TransactionType.Income ? "badge-income" : "badge-expense")">
                                                            @split.CategoryName
                                                        </span>
                                                    </td>
                                                    <td style="padding: 0.25rem 0;">
                                                        @(split.Description ?? "—")
                                                    </td>
                                                    <td class="text-right amount @(tx.Type == TransactionType.Income ? "income" : "expense")" 
                                                        style="padding: 0.25rem 0; width: 120px;">
                                                        @split.Amount.ToString("C")
                                                    </td>
                                                </tr>
                                            }
                                        </table>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    @if (!transactions.Any())
                    {
                        <tr>
                            <td colspan="9" class="text-center text-muted" style="padding: 2rem;">
                                No transactions found
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

<!-- Pagination -->
@if (totalPages > 0)
{
    <Pagination 
        CurrentPage="filter.Page"
        PageSize="filter.PageSize"
        TotalItems="totalCount"
        ShowPageNumbers="true"
        ShowPageSizeSelector="true"
        ShowItemCount="false"
        OnPageChange="OnPageChange"
        OnPageSizeChange="OnPageSizeChange" />
}

<!-- Transaction Summary Footer -->
@if (transactions.Any())
{
    <div class="card mt-2">
        <div class="card-body d-flex justify-between align-center flex-wrap gap-2" style="padding: 0.75rem 1rem;">
            <span class="text-muted">Page total: <strong>@transactions.Count</strong> transactions</span>
            <div class="d-flex gap-3">
                <span class="amount income">
                    <i class="fas fa-arrow-down"></i> Income: <strong>@transactions.Where(t => t.Type == TransactionType.Income).Sum(t => t.Amount).ToString("C2")</strong>
                </span>
                <span class="amount expense">
                    <i class="fas fa-arrow-up"></i> Expenses: <strong>@transactions.Where(t => t.Type == TransactionType.Expense).Sum(t => t.Amount).ToString("C2")</strong>
                </span>
                @{
                    var pageNet = transactions.Where(t => t.Type == TransactionType.Income).Sum(t => t.Amount) 
                                - transactions.Where(t => t.Type == TransactionType.Expense).Sum(t => t.Amount);
                }
                <span class="@(pageNet >= 0 ? "text-success" : "text-danger")">
                    Net: <strong>@pageNet.ToString("C2")</strong>
                </span>
            </div>
        </div>
    </div>
}

<!-- Edit/Add Modal -->
@if (showForm)
{
    <TransactionForm 
        Transaction="selectedTransaction"
        Categories="categories"
        Funds="funds"
        PreFillAmount="@receiptData?.Amount"
        PreFillDescription="@receiptData?.Description"
        PreFillDate="@receiptData?.Date"
        PreFillPayee="@receiptData?.Payee"
        OnSave="OnTransactionSaved"
        OnCancel="CloseForm" />
}

<!-- Delete Confirmation Dialog -->
<ConfirmDialog 
    IsVisible="showDeleteConfirm"
    Title="Delete Transaction"
    Message="Are you sure you want to delete this transaction?"
    ItemName="@GetDeleteItemName()"
    Type="ConfirmDialog.ConfirmationType.Delete"
    ConfirmText="Delete"
    ShowWarning="true"
    WarningMessage="This will move the transaction to the recycle bin. Fund balances will be recalculated."
    IsProcessing="isDeleting"
    OnConfirmClicked="ConfirmDelete"
    OnCancelClicked="CancelDelete" />

<!-- Batch Delete Confirmation -->
<ConfirmDialog 
    IsVisible="showBatchDeleteConfirm"
    Title="Delete Selected Transactions"
    Message="@($"Are you sure you want to delete {selectedTransactionIds.Count} selected transaction(s)?")"
    Type="ConfirmDialog.ConfirmationType.Delete"
    ConfirmText="Delete All Selected"
    ShowWarning="true"
    WarningMessage="This will move all selected transactions to the recycle bin. Fund balances will be recalculated."
    IsProcessing="isBatchDeleting"
    OnConfirmClicked="ConfirmBatchDelete"
    OnCancelClicked="CancelBatchDelete" />

@code {
private List<TransactionDto> transactions = new();
private List<CategoryDto> categories = new();
private List<FundDto> funds = new();
private List<DonorDto> donors = new();
private List<GrantDto> grants = new();
private TransactionFilterModel filter = new();
private TransactionDto? selectedTransaction;
private TransactionDto? transactionToDelete;
private HashSet<int> expandedTransactions = new();
private bool isLoading = true;
private bool isFiltering = false;
private bool showForm = false;
private bool showDeleteConfirm = false;
private bool isDeleting = false;
private int totalCount = 0;
private int totalPages = 1;

// Receipt pre-fill data
private ReceiptPreFillData? receiptData;

// Batch selection
private HashSet<int> selectedTransactionIds = new();
private bool showBatchDeleteConfirm = false;
private bool isBatchDeleting = false;

private bool isAllSelected => transactions.Any() && transactions.All(t => selectedTransactionIds.Contains(t.Id));

private void ToggleSelectTransaction(int id)
{
    if (!selectedTransactionIds.Remove(id))
        selectedTransactionIds.Add(id);
}

private void ToggleSelectAll()
{
    if (isAllSelected)
        selectedTransactionIds.Clear();
    else
        selectedTransactionIds = transactions.Select(t => t.Id).ToHashSet();
}

private void DeselectAll()
{
    selectedTransactionIds.Clear();
}

private void ShowBatchDeleteConfirm()
{
    showBatchDeleteConfirm = true;
}

private async Task ConfirmBatchDelete()
{
    isBatchDeleting = true;
    var count = selectedTransactionIds.Count;
    try
    {
        foreach (var id in selectedTransactionIds.ToList())
        {
            await TransactionService.DeleteAsync(id);
        }
        selectedTransactionIds.Clear();
        showBatchDeleteConfirm = false;
        await LoadTransactions();
        Toast.ShowSuccess($"{count} transaction(s) moved to recycle bin", "Batch Delete");
    }
    catch (Exception ex)
    {
        Toast.ShowError($"Failed to delete some transactions: {ex.Message}");
    }
    finally
    {
        isBatchDeleting = false;
    }
}

private void CancelBatchDelete()
{
    showBatchDeleteConfirm = false;
}

// Sort state
private string sortColumn = "Date";
private SortableHeader.SortDirection sortDirection = SortableHeader.SortDirection.Descending;

private IEnumerable<TransactionDto> SortedTransactions
{
    get
    {
        var filtered = filter.UnreconciledOnly 
            ? transactions.Where(t => !t.IsReconciled)
            : transactions.AsEnumerable();
        
        var sorted = sortColumn switch
        {
            "Date" => sortDirection == SortableHeader.SortDirection.Ascending
                ? filtered.OrderBy(t => t.Date)
                : filtered.OrderByDescending(t => t.Date),
            "Account" => sortDirection == SortableHeader.SortDirection.Ascending
                ? filtered.OrderBy(t => t.FundName ?? "")
                : filtered.OrderByDescending(t => t.FundName ?? ""),
            "Payee" => sortDirection == SortableHeader.SortDirection.Ascending
                ? filtered.OrderBy(t => t.DonorName ?? t.Payee ?? "")
                : filtered.OrderByDescending(t => t.DonorName ?? t.Payee ?? ""),
            "Category" => sortDirection == SortableHeader.SortDirection.Ascending
                ? filtered.OrderBy(t => t.CategoryName)
                : filtered.OrderByDescending(t => t.CategoryName),
            "Amount" => sortDirection == SortableHeader.SortDirection.Ascending
                ? filtered.OrderBy(t => t.Amount)
                : filtered.OrderByDescending(t => t.Amount),
            _ => filtered.OrderByDescending(t => t.Date)
        };
        return sorted;
    }
}

private void HandleSort((string Column, SortableHeader.SortDirection Direction) sort)
{
    sortColumn = sort.Column;
    sortDirection = sort.Direction;
}

// MED-09 fix: Debounce timer for search
private System.Timers.Timer? _debounceTimer;
private const int DebounceDelayMs = 300;

private bool HasActiveFilters =>
filter.CategoryId.HasValue ||
filter.FundId.HasValue ||
filter.DonorId.HasValue ||
filter.GrantId.HasValue ||
filter.Type.HasValue ||
filter.UnreconciledOnly ||
!string.IsNullOrWhiteSpace(filter.SearchTerm) ||
!string.IsNullOrWhiteSpace(filter.Tags);

protected override async Task OnInitializedAsync()
{
    filter.StartDate = DateTime.Today.AddMonths(-1);
    filter.EndDate = DateTime.Today;
        
    categories = await CategoryService.GetAllAsync();
    funds = await FundService.GetAllAsync();
    donors = await DonorService.GetAllAsync();
    grants = await GrantService.GetAllAsync(null);
    
    // Check for search parameter from global search
    var uri = new Uri(Navigation.Uri);
    var query = HttpUtility.ParseQueryString(uri.Query);
    var searchParam = query["search"];
    if (!string.IsNullOrEmpty(searchParam))
    {
        filter.SearchTerm = searchParam;
        // Expand date range to last year when coming from search
        filter.StartDate = DateTime.Today.AddYears(-1);
    }
        
    // Check if we're coming from a receipt OCR
    CheckForReceiptPreFill();
    
    await LoadTransactions();
}

private void ToggleExpand(int transactionId)
{
    if (expandedTransactions.Contains(transactionId))
        expandedTransactions.Remove(transactionId);
    else
        expandedTransactions.Add(transactionId);
}

private async Task LoadTransactions()
{
        isLoading = true;
        
        try
        {
            var request = new TransactionFilterRequest(
                filter.StartDate,
                filter.EndDate,
                filter.CategoryId,
                filter.FundId,
                filter.DonorId,
                filter.GrantId,
                filter.Type,
                filter.SearchTerm,
                filter.Tags,
                false,
                filter.Page,
                filter.PageSize
            );
            
            var result = await TransactionService.GetAllAsync(request);
            transactions = result.Items;
            totalCount = result.TotalCount;
            totalPages = result.TotalPages;
        }
        catch (Exception ex)
        {
            transactions = [];
            totalCount = 0;
            totalPages = 1;
            Toast.ShowError($"Failed to load transactions: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ApplyFilters()
    {
        filter.Page = 1;
        isFiltering = true;
        StateHasChanged();
        await LoadTransactions();
        isFiltering = false;
    }

    private async Task OnCategoryChanged(ChangeEventArgs e)
    {
        filter.CategoryId = string.IsNullOrEmpty(e.Value?.ToString()) ? null : int.Parse(e.Value.ToString()!);
        await ApplyFilters();
    }

    private async Task OnFundChanged(ChangeEventArgs e)
    {
        filter.FundId = string.IsNullOrEmpty(e.Value?.ToString()) ? null : int.Parse(e.Value.ToString()!);
        await ApplyFilters();
    }

    private async Task OnDonorChanged(ChangeEventArgs e)
    {
        filter.DonorId = string.IsNullOrEmpty(e.Value?.ToString()) ? null : int.Parse(e.Value.ToString()!);
        await ApplyFilters();
    }

    private async Task OnGrantChanged(ChangeEventArgs e)
    {
        filter.GrantId = string.IsNullOrEmpty(e.Value?.ToString()) ? null : int.Parse(e.Value.ToString()!);
        await ApplyFilters();
    }

    private void OnReconciledFilterChanged(ChangeEventArgs e)
    {
        filter.UnreconciledOnly = (bool)(e.Value ?? false);
        StateHasChanged();
    }

    private async Task OnTypeChanged(ChangeEventArgs e)
    {
        if (string.IsNullOrEmpty(e.Value?.ToString()))
        {
            filter.Type = null;
        }
        else if (Enum.TryParse<TransactionType>(e.Value.ToString(), out var type))
        {
            filter.Type = type;
        }
        await ApplyFilters();
    }

    // Debounced date change handler
    private void OnDateChanged()
    {
        _debounceTimer?.Stop();
        _debounceTimer?.Dispose();
        
        _debounceTimer = new System.Timers.Timer(DebounceDelayMs);
        _debounceTimer.Elapsed += async (sender, args) =>
        {
            _debounceTimer?.Stop();
            await InvokeAsync(async () =>
            {
                await ApplyFilters();
                StateHasChanged();
            });
        };
        _debounceTimer.AutoReset = false;
        _debounceTimer.Start();
    }

    // Debounced tags change handler
    private void OnTagsChanged()
    {
        _debounceTimer?.Stop();
        _debounceTimer?.Dispose();
        
        _debounceTimer = new System.Timers.Timer(DebounceDelayMs);
        _debounceTimer.Elapsed += async (sender, args) =>
        {
            _debounceTimer?.Stop();
            await InvokeAsync(async () =>
            {
                await ApplyFilters();
                StateHasChanged();
            });
        };
        _debounceTimer.AutoReset = false;
        _debounceTimer.Start();
    }

    // MED-09 fix: Debounced search handler
    private void OnSearchTermChanged()
    {
        _debounceTimer?.Stop();
        _debounceTimer?.Dispose();
        
        _debounceTimer = new System.Timers.Timer(DebounceDelayMs);
        _debounceTimer.Elapsed += async (sender, args) =>
        {
            _debounceTimer?.Stop();
            await InvokeAsync(async () =>
            {
                await ApplyFilters();
                StateHasChanged();
            });
        };
        _debounceTimer.AutoReset = false;
        _debounceTimer.Start();
    }

    private async Task ClearFilters()
    {
        filter = new TransactionFilterModel
        {
            StartDate = DateTime.Today.AddMonths(-1),
            EndDate = DateTime.Today
        };
        await LoadTransactions();
    }

    private async Task OnPageChange(int page)
    {
        filter.Page = page;
        await LoadTransactions();
    }

    private async Task OnPageSizeChange(int pageSize)
    {
        filter.PageSize = pageSize;
        filter.Page = 1;
        await LoadTransactions();
    }

    private void ShowAddForm()
    {
        selectedTransaction = null;
        showForm = true;
        
        // If we have receipt data, show form immediately
        if (receiptData != null)
        {
            TtsService.AnnounceSuccessAsync($"Creating transaction from receipt");
        }
        
        StateHasChanged();
    }

    private void CheckForReceiptPreFill()
    {
        var uri = new Uri(Navigation.Uri);
        var query = HttpUtility.ParseQueryString(uri.Query);
        
        if (query["fromReceipt"] == "true")
        {
            receiptData = new ReceiptPreFillData
            {
                Amount = decimal.TryParse(query["amount"], out var amt) ? amt : null,
                Description = query["description"],
                Date = DateTime.TryParse(query["date"], out var dt) ? dt : null,
                Payee = query["payee"]
            };
            
            // Auto-show the form with pre-filled data
            ShowAddForm();
        }
    }
    
    private class ReceiptPreFillData
    {
        public decimal? Amount { get; set; }
        public string? Description { get; set; }
        public DateTime? Date { get; set; }
        public string? Payee { get; set; }
    }

    private void EditTransaction(TransactionDto tx)
    {
        selectedTransaction = tx;
        showForm = true;
        StateHasChanged();
    }

    private void DeleteTransaction(TransactionDto tx)
    {
        transactionToDelete = tx;
        showDeleteConfirm = true;
        StateHasChanged();
    }

    private async Task ConfirmDelete()
    {
        if (transactionToDelete == null) return;
        
        isDeleting = true;
        try
        {
            await TransactionService.DeleteAsync(transactionToDelete.Id);
            await LoadTransactions();
            showDeleteConfirm = false;
            Toast.ShowSuccess("Transaction moved to recycle bin", "Deleted");
            transactionToDelete = null;
        }
        catch (Exception ex)
        {
            Toast.ShowError($"Failed to delete transaction: {ex.Message}", "Error");
        }
        finally
        {
            isDeleting = false;
        }
    }

    private void CancelDelete()
    {
        showDeleteConfirm = false;
        transactionToDelete = null;
    }

    private string GetDeleteItemName()
    {
        if (transactionToDelete == null) return "";
        var desc = transactionToDelete.Description ?? transactionToDelete.Payee;
        var amount = $"{transactionToDelete.Type} - {transactionToDelete.Amount:C}";
        return !string.IsNullOrWhiteSpace(desc) ? $"{desc} ({amount})" : amount;
    }

    private async Task OnTransactionSaved()
    {
        showForm = false;
        receiptData = null; // Clear receipt data after use
        await LoadTransactions();
        
        // Show toast notification
        Toast.ShowSuccess("Transaction saved successfully", "Saved");
        
        // Announce with TTS
        await TtsService.AnnounceSuccessAsync("Transaction saved successfully");
    }

    private void CloseForm()
    {
        showForm = false;
    }

    private class TransactionFilterModel
    {
        public DateTime? StartDate { get; set; }
        public DateTime? EndDate { get; set; }
        public int? CategoryId { get; set; }
        public int? FundId { get; set; }
        public int? DonorId { get; set; }
        public int? GrantId { get; set; }
        public TransactionType? Type { get; set; }
        public string? SearchTerm { get; set; }
        public string? Tags { get; set; }
        public bool UnreconciledOnly { get; set; }
        public int Page { get; set; } = 1;
        public int PageSize { get; set; } = 25;
    }

    public void Dispose()
    {
        _debounceTimer?.Stop();
        _debounceTimer?.Dispose();
    }
}
