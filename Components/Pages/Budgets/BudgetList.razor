@page "/budgets"
@inject IBudgetService BudgetService
@inject ICategoryService CategoryService
@inject IToastService ToastService
@rendermode InteractiveServer

<PageTitle>Budgets - NonProfit Finance</PageTitle>

<div class="d-flex justify-between align-center mb-3">
    <div>
        <h2 style="margin: 0;">Budget vs Actual</h2>
        <p class="text-muted">Track spending against budget targets</p>
    </div>
    <div class="d-flex gap-2">
        <select class="form-control" value="@selectedYear" @onchange="OnYearChanged">
            @for (int year = DateTime.Today.Year + 1; year >= DateTime.Today.Year - 3; year--)
            {
                <option value="@year">FY @year</option>
            }
        </select>
        <button class="btn btn-outline" @onclick="LoadBudget">
            <i class="fas fa-sync"></i> Refresh
        </button>
        <button class="btn btn-primary" @onclick="ShowCreateForm">
            <i class="fas fa-plus"></i> Create Budget
        </button>
    </div>
</div>

@if (budget != null && budget.LineItems.Any())
{
    <div class="d-flex gap-3 align-center mb-3">
        <SearchInput @bind-Value="budgetSearch" 
                     Placeholder="Search categories..." 
                     OnSearch="OnBudgetSearchChanged"
                     DebounceMs="300"
                     Style="width: 250px;" />
        <label class="d-flex align-center gap-2" style="margin-bottom: 0;">
            <input type="checkbox" checked="@showOverBudgetOnly" @onchange="OnOverBudgetToggled" />
            Over Budget Only
        </label>
    </div>
}

@if (isLoading)
{
    <div class="loading">
        <div class="spinner"></div>
    </div>
}
else if (budget != null)
{
    <!-- Summary Cards -->
    <div class="metric-cards mb-3">
        <div class="metric-card">
            <div class="metric-icon primary">
                <i class="fas fa-bullseye"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Total Budget</div>
                <div class="metric-value">@budget.TotalBudget.ToString("C2")</div>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon expense">
                <i class="fas fa-receipt"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Total Spent</div>
                <div class="metric-value negative">@budget.TotalSpent.ToString("C2")</div>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon @(budget.Remaining >= 0 ? "income" : "expense")">
                <i class="fas @(budget.Remaining >= 0 ? "fa-check-circle" : "fa-exclamation-circle")"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Remaining</div>
                <div class="metric-value @(budget.Remaining >= 0 ? "positive" : "negative")">@budget.Remaining.ToString("C2")</div>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon neutral">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Used</div>
                <div class="metric-value">@budget.PercentageUsed.ToString("N1")%</div>
            </div>
        </div>
    </div>

    <!-- Overall Progress -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="d-flex justify-between mb-2">
                <strong>Overall Budget Progress</strong>
                <span>
                    @budget.TotalSpent.ToString("C2") / @budget.TotalBudget.ToString("C2")
                    @if (budget.PercentageUsed > 100)
                    {
                        <span class="text-danger ml-2">
                            <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                            Over budget by @((budget.PercentageUsed - 100).ToString("N0"))%
                        </span>
                    }
                </span>
            </div>
            <div class="progress" style="height: 24px; overflow: hidden; position: relative;">
                <div class="progress-bar @GetProgressBarClass(budget.PercentageUsed)" 
                     style="width: @Math.Min(budget.PercentageUsed, 100)%; transition: width 0.3s ease;"
                     role="progressbar"
                     aria-valuenow="@budget.PercentageUsed"
                     aria-valuemin="0"
                     aria-valuemax="100"
                     aria-label="Budget usage: @budget.PercentageUsed.ToString("N0")%">
                    @budget.PercentageUsed.ToString("N0")%
                </div>
                @if (budget.PercentageUsed > 100)
                {
                    <!-- Visual indicator for over-budget -->
                    <div style="position: absolute; right: 4px; top: 50%; transform: translateY(-50%); 
                                color: white; font-size: 0.75rem; font-weight: bold;">
                        <i class="fas fa-exclamation" aria-hidden="true"></i>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Budget Line Items -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title"><i class="fas fa-list"></i> Budget by Category</h3>
        </div>
        <div class="card-body" style="padding: 0;">
            @if (budget.LineItems.Any())
            {
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th class="text-right">Budget</th>
                            <th class="text-right">Actual</th>
                            <th class="text-right">Variance</th>
                            <th style="width: 200px;">Progress</th>
                            <th class="text-right">%</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in FilteredLineItems)
                        {
                            var isOverBudget = item.Variance < 0;
                            <tr>
                                <td>
                                    <span class="tree-color" style="background: @(item.CategoryColor ?? "#6c757d");"></span>
                                    @item.CategoryName
                                </td>
                                <td class="text-right">@item.BudgetAmount.ToString("C2")</td>
                                <td class="text-right amount expense">@item.ActualAmount.ToString("C2")</td>
                                <td class="text-right @(isOverBudget ? "text-danger" : "text-success")">
                                    @(isOverBudget ? "-" : "+")@Math.Abs(item.Variance).ToString("C2")
                                </td>
                                <td>
                                    <div class="progress" style="height: 16px;">
                                        <div class="progress-bar @GetProgressBarClass(item.PercentageUsed)" 
                                             style="width: @Math.Min(item.PercentageUsed, 100)%;">
                                        </div>
                                    </div>
                                </td>
                                <td class="text-right">
                                    <span class="badge @GetPercentageBadgeClass(item.PercentageUsed)">
                                        @item.PercentageUsed.ToString("N0")%
                                    </span>
                                </td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr style="font-weight: bold; background: var(--bg-secondary);">
                            <td>Total</td>
                            <td class="text-right">@budget.TotalBudget.ToString("C2")</td>
                            <td class="text-right amount expense">@budget.TotalSpent.ToString("C2")</td>
                            <td class="text-right @(budget.Remaining >= 0 ? "text-success" : "text-danger")">
                                @(budget.Remaining >= 0 ? "+" : "-")@Math.Abs(budget.Remaining).ToString("C2")
                            </td>
                            <td></td>
                            <td class="text-right">@budget.PercentageUsed.ToString("N0")%</td>
                        </tr>
                    </tfoot>
                </table>
            }
            else
            {
                <div class="text-center text-muted" style="padding: 2rem;">
                    <i class="fas fa-tags" style="font-size: 2rem;"></i>
                    <p class="mt-2">No budget limits set. Add budget limits to categories to see budget tracking.</p>
                    <a href="/categories" class="btn btn-outline">
                        <i class="fas fa-cog"></i> Manage Categories
                    </a>
                </div>
            }
        </div>
    </div>

    <!-- Info -->
    <div class="alert alert-info mt-3">
        <i class="fas fa-info-circle"></i>
        <strong>Tip:</strong> Set budget limits on expense categories in the 
        <a href="/categories">Category Manager</a> to enable budget tracking.
    </div>
}

@if (showBudgetForm)
{
    <BudgetFormModal Budget="selectedBudget" IsEdit="isEdit" OnClose="CloseForm" OnSaved="OnBudgetSaved" />
}

@code {
private int selectedYear = DateTime.Today.Year;
private BudgetDto? budget;
private bool isLoading = true;
private bool showBudgetForm = false;
private BudgetDto? selectedBudget;
private bool isEdit = false;
private string budgetSearch = "";
private bool showOverBudgetOnly = false;

private IEnumerable<BudgetLineItemDto> FilteredLineItems =>
    (budget?.LineItems ?? Enumerable.Empty<BudgetLineItemDto>())
        .Where(l => string.IsNullOrEmpty(budgetSearch) ||
                    l.CategoryName.Contains(budgetSearch, StringComparison.OrdinalIgnoreCase))
        .Where(l => !showOverBudgetOnly || l.Variance < 0)
        .OrderByDescending(l => l.PercentageUsed);

protected override async Task OnInitializedAsync()
{
    await LoadBudget();
}

private async Task OnYearChanged(ChangeEventArgs e)
{
    if (int.TryParse(e.Value?.ToString(), out var year))
    {
        selectedYear = year;
        await LoadBudget();
    }
}

private void OnBudgetSearchChanged(string value)
{
    budgetSearch = value;
    StateHasChanged();
}

private void OnOverBudgetToggled(ChangeEventArgs e)
{
    showOverBudgetOnly = (bool)(e.Value ?? false);
    StateHasChanged();
}

    private async Task LoadBudget()
    {
        isLoading = true;
        try
        {
            budget = await BudgetService.GetByYearAsync(selectedYear);
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load budget: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetProgressBarClass(decimal percentage)
    {
        if (percentage >= 100) return "danger";
        if (percentage >= 80) return "warning";
        return "";
    }

    private string GetPercentageBadgeClass(decimal percentage)
    {
        if (percentage >= 100) return "badge-danger";
        if (percentage >= 80) return "badge-warning";
        if (percentage >= 50) return "badge-info";
        return "badge-success";
    }

    private void ShowCreateForm()
    {
        selectedBudget = null;
        isEdit = false;
        showBudgetForm = true;
        StateHasChanged();
    }

    private void ShowEditForm(BudgetDto budgetToEdit)
    {
        selectedBudget = budgetToEdit;
        isEdit = true;
        showBudgetForm = true;
        StateHasChanged();
    }

    private void CloseForm()
    {
        showBudgetForm = false;
        selectedBudget = null;
        StateHasChanged();
    }

    private async Task OnBudgetSaved()
    {
        showBudgetForm = false;
        selectedBudget = null;
        await LoadBudget();
    }
}
