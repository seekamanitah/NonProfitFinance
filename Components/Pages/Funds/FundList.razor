@page "/funds"
@inject IFundService FundService
@inject IToastService Toast
@rendermode InteractiveServer

<PageTitle>Accounts - NonProfit Finance</PageTitle>

<!-- Header -->
<div class="d-flex justify-between align-center mb-3">
    <div>
        <h2 style="margin: 0;">Account Management</h2>
        <p class="text-muted">Track restricted and unrestricted accounts</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline" @onclick="RecalculateBalances" disabled="@isRecalculating">
            @if (isRecalculating)
            {
                <LoadingSpinner Size="LoadingSpinner.SpinnerSize.Small" />
            }
            else
            {
                <i class="fas fa-sync"></i>
            }
            Recalculate
        </button>
        <button class="btn btn-primary" @onclick="ShowAddForm">
            <i class="fas fa-plus"></i> Add Account
        </button>
    </div>
</div>

<!-- Filter Bar -->
<div class="d-flex gap-3 align-center mb-3 flex-wrap">
    <SearchInput 
        @bind-Value="searchTerm"
        OnSearch="OnSearchChanged"
        Placeholder="Search accounts..."
        AriaLabel="Search accounts"
        ShowClearButton="true"
        DebounceMs="300" />
    
    <div class="form-group" style="margin-bottom: 0;">
        <select class="form-control" value="@typeFilter" @onchange="OnTypeFilterChanged" aria-label="Filter by fund type">
            <option value="">All Types</option>
            @foreach (var type in Enum.GetValues<FundType>())
            {
                <option value="@type">@type</option>
            }
        </select>
    </div>
    
    <label class="d-flex align-center gap-2">
        <input type="checkbox" @bind="showInactive" @bind:after="StateHasChanged" /> Show Inactive
    </label>
</div>

<!-- Summary Cards -->
@if (isLoading)
{
    <SkeletonLoader Type="SkeletonLoader.SkeletonType.MetricCards" Count="4" />
}
else
{
    <div class="metric-cards mb-3">
        <div class="metric-card">
            <div class="metric-icon income">
                <i class="fas fa-unlock"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Unrestricted Accounts</div>
                <div class="metric-value positive">@unrestrictedTotal.ToString("C2")</div>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon primary">
                <i class="fas fa-lock"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Restricted Accounts</div>
                <div class="metric-value">@restrictedTotal.ToString("C2")</div>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon neutral">
                <i class="fas fa-clock"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Temporarily Restricted</div>
                <div class="metric-value">@tempRestrictedTotal.ToString("C2")</div>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon expense">
                <i class="fas fa-infinity"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Permanently Restricted</div>
                <div class="metric-value">@permRestrictedTotal.ToString("C2")</div>
            </div>
        </div>
    </div>
}

<!-- Accounts List -->
<PageWrapper IsLoading="@isLoading" 
         IsEmpty="@(!FilteredFunds.Any())"
         EmptyIcon="fas fa-wallet"
         EmptyTitle="No Accounts Found"
         EmptyMessage="No accounts match your filters. Try adjusting your search criteria.">
<Content>
    <div class="charts-grid" style="grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));">
        @foreach (var fund in FilteredFunds)
        {
                <div class="card" @key="fund.Id">
                <div class="card-header">
                    <h4 style="margin: 0;">@fund.Name</h4>
                    <span class="badge @GetTypeBadgeClass(fund.Type)">@fund.Type</span>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(fund.Description))
                    {
                        <p class="text-muted mb-2">@fund.Description</p>
                    }
                    
                    <div class="d-flex justify-between mb-2">
                        <span class="text-muted">Current Balance</span>
                        <span class="metric-value @(fund.Balance >= 0 ? "positive" : "negative")" style="font-size: 1.25rem;">
                            @fund.Balance.ToString("C")
                        </span>
                    </div>
                    
                    @if (fund.TargetBalance.HasValue)
                    {
                        <div class="mb-2">
                            <div class="d-flex justify-between mb-1">
                                <span class="text-muted">Target: @fund.TargetBalance.Value.ToString("C2")</span>
                                <span class="text-muted">@GetPercentage(fund).ToString("N1")%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar @GetProgressClass(fund)" 
                                     style="width: @Math.Min(GetPercentage(fund), 100)%;"></div>
                            </div>
                        </div>
                    }
                    
                    <div class="d-flex justify-between mt-3">
                        <span class="badge @(fund.IsActive ? "badge-success" : "badge-warning")">
                            @(fund.IsActive ? "Active" : "Inactive")
                        </span>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-outline" @onclick="() => EditFund(fund)" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline text-danger" @onclick="() => DeleteFund(fund)" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
    </Content>
</PageWrapper>

<!-- Delete Confirmation Dialog -->
<ConfirmDialog 
    IsVisible="showDeleteConfirm"
    Title="Delete Account"
    Message="Are you sure you want to delete this account?"
    ItemName="@fundToDelete?.Name"
    Type="ConfirmDialog.ConfirmationType.Delete"
    ConfirmText="Delete"
    ShowWarning="true"
    WarningMessage="This will permanently remove the account. Accounts with transactions cannot be deleted."
    IsProcessing="isDeleting"
    OnConfirmClicked="ConfirmDelete"
    OnCancelClicked="CancelDelete" />

<!-- Add/Edit Form Modal -->
@if (showForm)
{
    <FundFormModal 
        Fund="editingFund"
        OnSave="OnFundSaved"
        OnCancel="CloseForm" />
}

@code {
private List<FundDto> funds = new();
private FundDto? editingFund;
private FundDto? fundToDelete;
private string searchTerm = "";
private FundType? typeFilter;
private bool showInactive = true;
private bool isLoading = true;
private bool isRecalculating = false;
private bool isDeleting = false;
private bool showForm = false;
private bool showDeleteConfirm = false;

private IEnumerable<FundDto> FilteredFunds => funds
    .Where(f => showInactive || f.IsActive)
    .Where(f => string.IsNullOrEmpty(searchTerm) ||
                f.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                (f.Description?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false))
    .Where(f => !typeFilter.HasValue || f.Type == typeFilter.Value)
    .OrderBy(f => f.Name);
    
// Calculated summaries
private decimal unrestrictedTotal = 0;
private decimal restrictedTotal = 0;
private decimal tempRestrictedTotal = 0;
private decimal permRestrictedTotal = 0;

protected override async Task OnInitializedAsync()
{
    await LoadFunds();
}

private async Task LoadFunds()
{
    isLoading = true;
    try
    {
        funds = await FundService.GetAllAsync(true);
        
        // Calculate totals from ACTIVE funds only (matches Dashboard calculation)
        var activeFunds = funds.Where(f => f.IsActive).ToList();
        unrestrictedTotal = activeFunds.Where(f => f.Type == FundType.Unrestricted).Sum(f => f.Balance);
        restrictedTotal = activeFunds.Where(f => f.Type == FundType.Restricted).Sum(f => f.Balance);
        tempRestrictedTotal = activeFunds.Where(f => f.Type == FundType.TemporarilyRestricted).Sum(f => f.Balance);
        permRestrictedTotal = activeFunds.Where(f => f.Type == FundType.PermanentlyRestricted).Sum(f => f.Balance);
    }
    catch (Exception ex)
    {
        Toast.ShowError($"Failed to load accounts: {ex.Message}");
    }
    finally
    {
        isLoading = false;
    }
}

private async Task RecalculateBalances()
{
    isRecalculating = true;
    StateHasChanged();
    
    try
    {
        await FundService.RecalculateAllBalancesAsync();
        await LoadFunds();
        Toast.ShowSuccess("All account balances recalculated successfully.");
    }
    catch (Exception ex)
    {
        Toast.ShowError($"Failed to recalculate balances: {ex.Message}");
    }
    finally
    {
        isRecalculating = false;
    }
}

    private void ShowAddForm()
    {
        editingFund = null;
        showForm = true;
    }

    private void EditFund(FundDto fund)
    {
        editingFund = fund;
        showForm = true;
    }

    private void DeleteFund(FundDto fund)
    {
        fundToDelete = fund;
        showDeleteConfirm = true;
    }

    private async Task ConfirmDelete()
    {
        if (fundToDelete == null) return;
        isDeleting = true;
        try
        {
            await FundService.DeleteAsync(fundToDelete.Id);
            Toast.ShowSuccess($"Account '{fundToDelete.Name}' deleted.");
            await LoadFunds();
        }
        catch (InvalidOperationException ex)
        {
            Toast.ShowError(ex.Message);
        }
        catch (Exception ex)
        {
            Toast.ShowError($"Failed to delete account: {ex.Message}");
        }
        finally
        {
            isDeleting = false;
            showDeleteConfirm = false;
            fundToDelete = null;
        }
    }

    private void CancelDelete()
    {
        showDeleteConfirm = false;
        fundToDelete = null;
    }

    private async Task OnFundSaved()
    {
        showForm = false;
        await LoadFunds();
    }

    private void CloseForm()
    {
        showForm = false;
    }

    private async Task OnSearchChanged(string value)
    {
        searchTerm = value;
        await InvokeAsync(StateHasChanged);
    }

    private void OnTypeFilterChanged(ChangeEventArgs e)
    {
        if (string.IsNullOrEmpty(e.Value?.ToString()))
        {
            typeFilter = null;
        }
        else if (Enum.TryParse<FundType>(e.Value.ToString(), out var type))
        {
            typeFilter = type;
        }
        StateHasChanged();
    }

    private decimal GetPercentage(FundDto fund)
    {
        if (!fund.TargetBalance.HasValue || fund.TargetBalance.Value == 0) return 0;
        return (fund.Balance / fund.TargetBalance.Value) * 100;
    }

    private string GetProgressClass(FundDto fund)
    {
        var pct = GetPercentage(fund);
        if (pct >= 100) return "success";
        if (pct >= 75) return "";
        if (pct >= 50) return "warning";
        return "danger";
    }

    private string GetTypeBadgeClass(FundType type) => type switch
    {
        FundType.Unrestricted => "badge-success",
        FundType.Restricted => "badge-danger",
        FundType.TemporarilyRestricted => "badge-warning",
        FundType.PermanentlyRestricted => "badge-info",
        _ => "badge-info"
    };
}
