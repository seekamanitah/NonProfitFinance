@page "/"
@page "/dashboard"
@inject IReportService ReportService
@inject ITransactionService TransactionService
@inject IGrantService GrantService
@inject IComplianceService ComplianceService
@inject IToastService ToastService
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Dashboard - NonProfit Finance</PageTitle>

<PageHeader Title="Dashboard">
    <DemoBadge />
    <button class="btn btn-primary btn-quick-add" @onclick="ShowQuickAdd"
            style="font-weight: 600; padding: 0.6rem 1.25rem; box-shadow: 0 2px 8px rgba(196, 30, 58, 0.3);">
        <i class="fas fa-plus" aria-hidden="true"></i> Quick Add Transaction
    </button>
</PageHeader>

@if (showQuickAddModal)
{
    <QuickAddModal OnClose="CloseQuickAdd" OnSaved="OnQuickAddSaved" />
}

@if (isLoading)
{
    <div class="dashboard-loading">
        <!-- Skeleton metrics -->
        <SkeletonLoader Type="SkeletonLoader.SkeletonType.MetricCards" Count="4" />
        
        <!-- Skeleton charts -->
        <div class="charts-grid" style="margin-top: 1.5rem;">
            <SkeletonLoader Type="SkeletonLoader.SkeletonType.Card" />
            <SkeletonLoader Type="SkeletonLoader.SkeletonType.Card" />
        </div>
        
        <!-- Loading indicator -->
        <div style="margin-top: 1.5rem;">
            <LoadingSpinner Size="LoadingSpinner.SpinnerSize.Medium" Text="Loading dashboard data..." Centered="true" />
        </div>
    </div>
}
else
{
    <!-- Compliance Alerts -->
    @if (criticalReminders.Any())
    {
        <div class="alert alert-danger mb-3">
            <i class="fas fa-exclamation-circle"></i>
            <strong>Critical Deadlines:</strong>
            @foreach (var reminder in criticalReminders.Take(3))
            {
                <span class="ml-2">• @reminder.Title (due @reminder.DueDate.ToString("MMM d"))</span>
            }
            <a href="/compliance" class="btn btn-sm btn-outline ml-2" style="color: inherit; border-color: currentColor;">View All</a>
        </div>
    }

    <!-- Alert for Audit Threshold -->
    @if (isApproachingThreshold)
    {
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                <strong>Revenue Threshold Alert:</strong> Your YTD revenue is approaching the $1M audit threshold for Form 990.
                Current: @FormatCurrency(metrics?.YtdRevenue ?? 0) (@GetThresholdPercentage()% of threshold)
            </div>
        </div>
    }

    <!-- Metric Cards -->
    <div class="metric-cards">
        <MetricCard 
            Title="Monthly Net" 
            Value="@FormatCurrency(metrics?.MonthlyNetIncome ?? 0)"
            Icon="fa-calendar"
            IconType="@(metrics?.MonthlyNetIncome >= 0 ? "income" : "expense")"
            ValueClass="@(metrics?.MonthlyNetIncome >= 0 ? "positive" : "negative")" />
        
        <MetricCard 
            Title="YTD Net Income" 
            Value="@FormatCurrency(metrics?.YtdNetIncome ?? 0)"
            Icon="fa-chart-line"
            IconType="@(metrics?.YtdNetIncome >= 0 ? "income" : "expense")"
            ValueClass="@(metrics?.YtdNetIncome >= 0 ? "positive" : "negative")" />
        
        <MetricCard 
            Title="Total Cash Balance" 
            Value="@FormatCurrency(metrics?.TotalCashBalance ?? 0)"
            Icon="fa-wallet"
            IconType="neutral" />
        
        <MetricCard 
            Title="Restricted Accounts" 
            Value="@GetRestrictedPercentage()"
            Icon="fa-lock"
            IconType="primary"
            Subtitle="@FormatCurrency(metrics?.RestrictedBalance ?? 0)" />
    </div>
    
    <!-- Charts Row -->
    <div class="charts-grid">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Income vs Expenses Trend</h3>
                <select class="form-control" style="width: auto;" @bind="trendMonths" @bind:after="OnTrendPeriodChanged">
                    <option value="6">Last 6 Months</option>
                    <option value="12">Last 12 Months</option>
                    <option value="24">Last 24 Months</option>
                </select>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Expense Breakdown</h3>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bottom Row -->
    <div class="charts-grid">
        <!-- Cash Flow Forecast -->
        <CashFlowWidget />
        
        <!-- Recent Transactions with Inline Actions -->
        <div class="card recent-transactions-card">
            <div class="card-header">
                <h3 class="card-title">Recent Transactions</h3>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline" @onclick="ShowQuickAdd" title="Add Transaction">
                        <i class="fas fa-plus"></i>
                    </button>
                    <a href="/transactions" class="btn btn-sm btn-outline">View All</a>
                </div>
            </div>
            <div class="card-body" style="padding: 0;">
                <div class="recent-transactions-list">
                    @foreach (var tx in recentTransactions)
                    {
                        <div class="transaction-row @(selectedTransactionId == tx.Id ? "selected" : "")" 
                             @onclick="() => SelectTransaction(tx.Id)"
                             @onclick:stopPropagation="true">
                            <div class="transaction-icon @(tx.Type == TransactionType.Income ? "income" : "expense")">
                                <i class="fas @GetTransactionIcon(tx.Type)"></i>
                            </div>
                            <div class="transaction-main">
                                <div class="transaction-header">
                                    <span class="transaction-description">@(tx.Description ?? tx.Payee ?? "—")</span>
                                    <span class="transaction-amount @(tx.Type == TransactionType.Income ? "income" : "expense")">
                                        @(tx.Type == TransactionType.Income ? "+" : "-")@FormatCurrency(tx.Amount)
                                    </span>
                                </div>
                                <div class="transaction-meta">
                                    <span class="transaction-date">
                                        <i class="fas fa-calendar"></i> @tx.Date.ToString("MMM dd, yyyy")
                                    </span>
                                    @if (!string.IsNullOrEmpty(tx.CategoryName))
                                    {
                                        <span class="transaction-category">
                                            <i class="fas fa-tag"></i> @tx.CategoryName
                                        </span>
                                    }
                                    @if (!string.IsNullOrEmpty(tx.FundName))
                                    {
                                        <span class="transaction-fund">
                                            <i class="fas fa-folder"></i> @tx.FundName
                                        </span>
                                    }
                                </div>
                            </div>
                            <div class="transaction-actions">
                                <button class="btn-icon" @onclick="() => ViewTransaction(tx.Id)" @onclick:stopPropagation="true" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-icon" @onclick="() => EditTransaction(tx.Id)" @onclick:stopPropagation="true" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon" @onclick="() => DuplicateTransaction(tx)" @onclick:stopPropagation="true" title="Duplicate">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button class="btn-icon danger" @onclick="() => ConfirmDeleteTransaction(tx)" @onclick:stopPropagation="true" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    }
                    @if (!recentTransactions.Any())
                    {
                        <div class="empty-transactions">
                            <i class="fas fa-receipt"></i>
                            <p>No recent transactions</p>
                            <button class="btn btn-primary btn-sm" @onclick="ShowQuickAdd">Add Transaction</button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
    
    <!-- Third Row - Budget & Grants -->
    <div class="charts-grid">
        <BudgetProgressWidget MaxCategories="4" />
        <GrantStatusWidget MaxGrants="3" />
    </div>
    
    <!-- Fourth Row - Top Donors -->
    <div class="charts-grid">
        <TopDonorsWidget MaxDonors="5" />
        
        <!-- Upcoming Deadlines -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Upcoming Deadlines</h3>
            </div>
            <div class="card-body">
                @if (expiringGrants.Any() || upcomingReports.Any())
                {
                    @foreach (var grant in expiringGrants.Take(3))
                    {
                        <div class="alert alert-warning mb-2">
                            <i class="fas fa-clock"></i>
                            <div>
                                <strong>@grant.Name</strong> expires @grant.EndDate?.ToString("MMM dd, yyyy")
                            </div>
                        </div>
                    }
                    
                    @foreach (var grant in upcomingReports.Take(3))
                    {
                        <div class="alert alert-info mb-2" style="background: rgba(23, 162, 184, 0.1); border-color: var(--color-info);">
                            <i class="fas fa-file-alt"></i>
                            <div>
                                <strong>@grant.Name</strong> report due @grant.NextReportDueDate?.ToString("MMM dd, yyyy")
                            </div>
                        </div>
                    }
                }
                else
                {
                    <p class="text-muted text-center">No upcoming deadlines</p>
                }
                
                <div class="mt-3 d-flex gap-2">
                    <div class="metric-card" style="flex: 1; padding: 1rem;">
                        <div class="metric-content">
                            <div class="metric-label">Active Grants</div>
                            <div class="metric-value">@(metrics?.ActiveGrantsCount ?? 0)</div>
                        </div>
                    </div>
                    <div class="metric-card" style="flex: 1; padding: 1rem;">
                        <div class="metric-content">
                            <div class="metric-label">Active Donors</div>
                            <div class="metric-value">@(metrics?.ActiveDonorsCount ?? 0)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@* Delete Confirmation Modal *@
@if (showDeleteConfirm && transactionToDelete != null)
{
    <ConfirmationModal 
        Title="Delete Transaction"
        Message="@($"Are you sure you want to delete the transaction \"{transactionToDelete.Description ?? transactionToDelete.Payee ?? "this transaction"}\" for {FormatCurrency(transactionToDelete.Amount)}? This action can be undone from the Recycle Bin.")"
        ConfirmText="Delete"
        ConfirmButtonClass="btn-danger"
        OnConfirm="DeleteTransaction"
        OnCancel="CancelDelete" />
}

<style>
    .recent-transactions-card .card-body {
        max-height: 400px;
        overflow-y: auto;
    }

    .recent-transactions-list {
        display: flex;
        flex-direction: column;
    }

    .transaction-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        transition: background-color 0.15s ease;
    }

    .transaction-row:hover {
        background-color: var(--bg-secondary);
    }

    .transaction-row.selected {
        background-color: rgba(196, 30, 58, 0.05);
        border-left: 3px solid var(--primary-color);
    }

    .transaction-row:last-child {
        border-bottom: none;
    }

    .transaction-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .transaction-icon.income {
        background: rgba(34, 197, 94, 0.1);
        color: #22c55e;
    }

    .transaction-icon.expense {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .transaction-main {
        flex: 1;
        min-width: 0;
    }

    .transaction-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
    }

    .transaction-description {
        font-weight: 500;
        font-size: 0.9375rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .transaction-amount {
        font-weight: 600;
        font-size: 0.9375rem;
        white-space: nowrap;
    }

    .transaction-amount.income {
        color: #22c55e;
    }

    .transaction-amount.expense {
        color: #ef4444;
    }

    .transaction-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-top: 0.25rem;
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .transaction-meta span {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .transaction-actions {
        display: flex;
        gap: 0.25rem;
        opacity: 0;
        transition: opacity 0.15s ease;
    }

    .transaction-row:hover .transaction-actions,
    .transaction-row.selected .transaction-actions {
        opacity: 1;
    }

    .btn-icon {
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        border-radius: var(--radius);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--text-muted);
        transition: all 0.15s ease;
    }

    .btn-icon:hover {
        background: var(--bg-secondary);
        color: var(--primary-color);
    }

    .btn-icon.danger:hover {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .empty-transactions {
        text-align: center;
        padding: 2rem;
        color: var(--text-muted);
    }

    .empty-transactions i {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .empty-transactions p {
        margin-bottom: 1rem;
    }

    @@media (max-width: 640px) {
        .transaction-actions {
            opacity: 1;
        }

        .transaction-meta {
            flex-direction: column;
            gap: 0.25rem;
        }

        .transaction-header {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>

@code {
private DashboardMetricsDto? metrics;
private List<TransactionDto> recentTransactions = new();
private List<GrantDto> expiringGrants = new();
private List<GrantDto> upcomingReports = new();
private List<ComplianceReminderDto> criticalReminders = new();
private bool isLoading = true;
private bool isApproachingThreshold = false;
private bool showQuickAddModal = false;
private bool showDeleteConfirm = false;
private TransactionDto? transactionToDelete;
private int? selectedTransactionId;
private List<TrendDataDto> trendData = new();
private List<CategorySummaryDto> expenseBreakdown = new();
private int trendMonths = 12;

private bool _jsReady;

protected override async Task OnInitializedAsync()
{
    await LoadDashboardData();
}

protected override async Task OnAfterRenderAsync(bool firstRender)
{
    if (firstRender)
    {
        _jsReady = true;
    }

    if (_jsReady && !isLoading && trendData.Any())
    {
        try
        {
            await RenderCharts();
        }
        catch (Microsoft.JSInterop.JSException) { }
    }
}

private async Task LoadDashboardData()
{
    isLoading = true;

    try
    {
        metrics = await ReportService.GetDashboardMetricsAsync();
        isApproachingThreshold = await ReportService.IsApproachingAuditThresholdAsync();
        recentTransactions = await TransactionService.GetRecentAsync(5);
        expiringGrants = await GrantService.GetExpiringGrantsAsync(30);
        upcomingReports = await GrantService.GetGrantsWithUpcomingReportsAsync(14);
        
        // Load critical compliance reminders
        var allReminders = await ComplianceService.GetUpcomingRemindersAsync(30);
        criticalReminders = allReminders.Where(r => r.Priority == ReminderPriority.Critical || r.Priority == ReminderPriority.High).ToList();
            
        await LoadTrendData();
        await LoadExpenseBreakdown();
    }
    catch (Exception ex)
    {
        ToastService.ShowError($"Failed to load dashboard data: {ex.Message}");
    }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadTrendData()
    {
        var endDate = DateTime.UtcNow;
        var startDate = endDate.AddMonths(-trendMonths);
        trendData = await ReportService.GetTrendDataAsync(startDate, endDate, "monthly");
    }

    private async Task LoadExpenseBreakdown()
    {
        var startOfYear = new DateTime(DateTime.UtcNow.Year, 1, 1);
        var filter = new ReportFilterRequest(startOfYear, DateTime.UtcNow);
        expenseBreakdown = await ReportService.GetCategoryBreakdownAsync(filter);
    }

    private async Task RenderCharts()
    {
        // Render trend line chart
        if (trendData.Any())
        {
            var labels = trendData.Select(t => t.Period.ToString("MMM yy")).ToArray();
            var incomeData = trendData.Select(t => t.Income).ToArray();
            var expenseData = trendData.Select(t => t.Expenses).ToArray();

            await JS.InvokeVoidAsync("chartInterop.createLineChart", "trendChart",
                labels,
                new[]
                {
                    new { label = "Income", data = incomeData, borderColor = "#28a745", backgroundColor = "rgba(40, 167, 69, 0.1)", fill = true },
                    new { label = "Expenses", data = expenseData, borderColor = "#dc3545", backgroundColor = "rgba(220, 53, 69, 0.1)", fill = true }
                },
                new { });
        }

        // Render expense pie chart
        if (expenseBreakdown.Any())
        {
            var labels = expenseBreakdown.Select(e => e.CategoryName).ToArray();
            var data = expenseBreakdown.Select(e => e.Amount).ToArray();
            var colors = expenseBreakdown.Select(e => e.Color ?? "#6c757d").ToArray();

            await JS.InvokeVoidAsync("chartInterop.createPieChart", "expenseChart",
                labels, data, colors, new { });
        }
    }

    private async Task OnTrendPeriodChanged()
    {
        await LoadTrendData();
        try
        {
            await RenderCharts();
        }
        catch (Microsoft.JSInterop.JSException) { }
    }

    private static string FormatCurrency(decimal value)
    {
        return value.ToString("C2");
    }

    private string GetRestrictedPercentage()
    {
        return $"{(metrics?.RestrictedFundsPercentage ?? 0):N1}%";
    }

    private string GetThresholdPercentage()
    {
        var ytdRevenue = Math.Max(0, metrics?.YtdRevenue ?? 0);
        return ((ytdRevenue / 1_000_000m) * 100).ToString("N1");
    }

    private void ShowQuickAdd()
    {
        showQuickAddModal = true;
    }

    private void CloseQuickAdd()
    {
        showQuickAddModal = false;
    }

    private async Task OnQuickAddSaved()
    {
        showQuickAddModal = false;
        await LoadDashboardData();
        await RenderCharts();
    }

    // Transaction inline action methods
    private void SelectTransaction(int id)
    {
        selectedTransactionId = selectedTransactionId == id ? null : id;
    }

    private void ViewTransaction(int id)
    {
        NavigationManager.NavigateTo($"/transactions/{id}");
    }

    private void EditTransaction(int id)
    {
        NavigationManager.NavigateTo($"/transactions/{id}/edit");
    }

    private async Task DuplicateTransaction(TransactionDto tx)
    {
        try
        {
            var duplicateRequest = new CreateTransactionRequest(
                Date: DateTime.Today,
                Amount: tx.Amount,
                Description: tx.Description,
                Type: tx.Type,
                CategoryId: tx.CategoryId,
                FundType: tx.FundType,
                FundId: tx.FundId,
                ToFundId: tx.ToFundId,
                DonorId: tx.DonorId,
                GrantId: tx.GrantId,
                Payee: tx.Payee,
                Tags: tx.Tags,
                ReferenceNumber: tx.ReferenceNumber,
                PONumber: tx.PONumber,
                IsRecurring: false
            );

            await TransactionService.CreateAsync(duplicateRequest);
            ToastService.ShowSuccess("Transaction duplicated successfully");
            await LoadDashboardData();
            await RenderCharts();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to duplicate: {ex.Message}");
        }
    }

    private void ConfirmDeleteTransaction(TransactionDto tx)
    {
        transactionToDelete = tx;
        showDeleteConfirm = true;
    }

    private async Task DeleteTransaction()
    {
        if (transactionToDelete == null) return;

        try
        {
            await TransactionService.DeleteAsync(transactionToDelete.Id);
            ToastService.ShowSuccess("Transaction deleted");
            showDeleteConfirm = false;
            transactionToDelete = null;
            await LoadDashboardData();
            await RenderCharts();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to delete: {ex.Message}");
        }
    }

    private void CancelDelete()
    {
        showDeleteConfirm = false;
        transactionToDelete = null;
    }

    private static string GetTransactionIcon(TransactionType type)
    {
        return type switch
        {
            TransactionType.Income => "fa-arrow-down",
            TransactionType.Expense => "fa-arrow-up",
            TransactionType.Transfer => "fa-exchange-alt",
            _ => "fa-receipt"
        };
    }
}
