@page "/"
@page "/dashboard"
@inject IReportService ReportService
@inject ITransactionService TransactionService
@inject IGrantService GrantService
@inject IComplianceService ComplianceService
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Dashboard - NonProfit Finance</PageTitle>

<PageHeader Title="Dashboard">
    <DemoBadge />
    <button class="btn btn-primary" @onclick="ShowQuickAdd">
        <i class="fas fa-plus"></i> Quick Add
    </button>
</PageHeader>

@if (showQuickAddModal)
{
    <QuickAddModal OnClose="CloseQuickAdd" OnSaved="OnQuickAddSaved" />
}

@if (isLoading)
{
    <div class="loading">
        <div class="spinner"></div>
        <span class="ml-2">Loading dashboard...</span>
    </div>
}
else
{
    <!-- Compliance Alerts -->
    @if (criticalReminders.Any())
    {
        <div class="alert alert-danger mb-3">
            <i class="fas fa-exclamation-circle"></i>
            <strong>Critical Deadlines:</strong>
            @foreach (var reminder in criticalReminders.Take(3))
            {
                <span class="ml-2">• @reminder.Title (due @reminder.DueDate.ToString("MMM d"))</span>
            }
            <a href="/compliance" class="btn btn-sm btn-outline ml-2" style="color: inherit; border-color: currentColor;">View All</a>
        </div>
    }

    <!-- Alert for Audit Threshold -->
    @if (isApproachingThreshold)
    {
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                <strong>Revenue Threshold Alert:</strong> Your YTD revenue is approaching the $1M audit threshold for Form 990.
                Current: @FormatCurrency(metrics?.YtdNetIncome ?? 0) (@GetThresholdPercentage()% of threshold)
            </div>
        </div>
    }

    <!-- Metric Cards -->
    <div class="metric-cards">
        <MetricCard 
            Title="Monthly Net" 
            Value="@FormatCurrency(metrics?.MonthlyNetIncome ?? 0)"
            Icon="fa-calendar"
            IconType="@(metrics?.MonthlyNetIncome >= 0 ? "income" : "expense")"
            ValueClass="@(metrics?.MonthlyNetIncome >= 0 ? "positive" : "negative")" />
        
        <MetricCard 
            Title="YTD Net Income" 
            Value="@FormatCurrency(metrics?.YtdNetIncome ?? 0)"
            Icon="fa-chart-line"
            IconType="@(metrics?.YtdNetIncome >= 0 ? "income" : "expense")"
            ValueClass="@(metrics?.YtdNetIncome >= 0 ? "positive" : "negative")" />
        
        <MetricCard 
            Title="Total Cash Balance" 
            Value="@FormatCurrency(metrics?.TotalCashBalance ?? 0)"
            Icon="fa-wallet"
            IconType="neutral" />
        
        <MetricCard 
            Title="Restricted Accounts" 
            Value="@GetRestrictedPercentage()"
            Icon="fa-lock"
            IconType="primary"
            Subtitle="@FormatCurrency(metrics?.RestrictedBalance ?? 0)" />
    </div>
    
    <!-- Charts Row -->
    <div class="charts-grid">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Income vs Expenses Trend</h3>
                <select class="form-control" style="width: auto;" @onchange="OnTrendPeriodChange">
                    <option value="6">Last 6 Months</option>
                    <option value="12" selected>Last 12 Months</option>
                    <option value="24">Last 24 Months</option>
                </select>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Expense Breakdown</h3>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bottom Row -->
    <div class="charts-grid">
        <!-- Cash Flow Forecast -->
        <CashFlowWidget />
        
        <!-- Recent Transactions -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Recent Transactions</h3>
                <a href="/transactions" class="btn btn-sm btn-outline">View All</a>
            </div>
            <div class="card-body" style="padding: 0;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th class="text-right">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var tx in recentTransactions)
                        {
                            <tr>
                                <td>@tx.Date.ToString("MMM dd")</td>
                                <td>@(tx.Description ?? tx.Payee ?? "—")</td>
                                <td>@tx.CategoryName</td>
                                <td class="text-right amount @(tx.Type == TransactionType.Income ? "income" : "expense")">
                                    @(tx.Type == TransactionType.Income ? "+" : "-")@FormatCurrency(tx.Amount)
                                </td>
                            </tr>
                        }
                        @if (!recentTransactions.Any())
                        {
                            <tr>
                                <td colspan="4" class="text-center text-muted">No recent transactions</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Third Row -->
    <div class="charts-grid">        
        <!-- Grants & Alerts -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Upcoming Deadlines</h3>
            </div>
            <div class="card-body">
                @if (expiringGrants.Any() || upcomingReports.Any())
                {
                    @foreach (var grant in expiringGrants.Take(3))
                    {
                        <div class="alert alert-warning mb-2">
                            <i class="fas fa-clock"></i>
                            <div>
                                <strong>@grant.Name</strong> expires @grant.EndDate?.ToString("MMM dd, yyyy")
                            </div>
                        </div>
                    }
                    
                    @foreach (var grant in upcomingReports.Take(3))
                    {
                        <div class="alert alert-info mb-2" style="background: rgba(23, 162, 184, 0.1); border-color: var(--color-info);">
                            <i class="fas fa-file-alt"></i>
                            <div>
                                <strong>@grant.Name</strong> report due @grant.NextReportDueDate?.ToString("MMM dd, yyyy")
                            </div>
                        </div>
                    }
                }
                else
                {
                    <p class="text-muted text-center">No upcoming deadlines</p>
                }
                
                <div class="mt-3 d-flex gap-2">
                    <div class="metric-card" style="flex: 1; padding: 1rem;">
                        <div class="metric-content">
                            <div class="metric-label">Active Grants</div>
                            <div class="metric-value">@(metrics?.ActiveGrantsCount ?? 0)</div>
                        </div>
                    </div>
                    <div class="metric-card" style="flex: 1; padding: 1rem;">
                        <div class="metric-content">
                            <div class="metric-label">Active Donors</div>
                            <div class="metric-value">@(metrics?.ActiveDonorsCount ?? 0)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
private DashboardMetricsDto? metrics;
private List<TransactionDto> recentTransactions = new();
private List<GrantDto> expiringGrants = new();
private List<GrantDto> upcomingReports = new();
private List<ComplianceReminderDto> criticalReminders = new();
private bool isLoading = true;
private bool isApproachingThreshold = false;
private bool showQuickAddModal = false;
private List<TrendDataDto> trendData = new();
private List<CategorySummaryDto> expenseBreakdown = new();
private int trendMonths = 12;

protected override async Task OnInitializedAsync()
{
    await LoadDashboardData();
}

protected override async Task OnAfterRenderAsync(bool firstRender)
{
    if (firstRender && !isLoading)
    {
        await RenderCharts();
    }
}

private async Task LoadDashboardData()
{
    isLoading = true;

    try
    {
        metrics = await ReportService.GetDashboardMetricsAsync();
        isApproachingThreshold = await ReportService.IsApproachingAuditThresholdAsync();
        recentTransactions = await TransactionService.GetRecentAsync(5);
        expiringGrants = await GrantService.GetExpiringGrantsAsync(30);
        upcomingReports = await GrantService.GetGrantsWithUpcomingReportsAsync(14);
        
        // Load critical compliance reminders
        var allReminders = await ComplianceService.GetUpcomingRemindersAsync(30);
        criticalReminders = allReminders.Where(r => r.Priority == ReminderPriority.Critical || r.Priority == ReminderPriority.High).ToList();
            
        await LoadTrendData();
        await LoadExpenseBreakdown();
    }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadTrendData()
    {
        var endDate = DateTime.UtcNow;
        var startDate = endDate.AddMonths(-trendMonths);
        trendData = await ReportService.GetTrendDataAsync(startDate, endDate, "monthly");
    }

    private async Task LoadExpenseBreakdown()
    {
        var startOfYear = new DateTime(DateTime.UtcNow.Year, 1, 1);
        var filter = new ReportFilterRequest(startOfYear, DateTime.UtcNow);
        expenseBreakdown = await ReportService.GetCategoryBreakdownAsync(filter);
    }

    private async Task RenderCharts()
    {
        // Render trend line chart
        if (trendData.Any())
        {
            var labels = trendData.Select(t => t.Period.ToString("MMM yy")).ToArray();
            var incomeData = trendData.Select(t => t.Income).ToArray();
            var expenseData = trendData.Select(t => t.Expenses).ToArray();

            await JS.InvokeVoidAsync("chartInterop.createLineChart", "trendChart",
                labels,
                new[]
                {
                    new { label = "Income", data = incomeData, borderColor = "#28a745", backgroundColor = "rgba(40, 167, 69, 0.1)", fill = true },
                    new { label = "Expenses", data = expenseData, borderColor = "#dc3545", backgroundColor = "rgba(220, 53, 69, 0.1)", fill = true }
                },
                new { });
        }

        // Render expense pie chart
        if (expenseBreakdown.Any())
        {
            var labels = expenseBreakdown.Select(e => e.CategoryName).ToArray();
            var data = expenseBreakdown.Select(e => e.Amount).ToArray();
            var colors = expenseBreakdown.Select(e => e.Color ?? "#6c757d").ToArray();

            await JS.InvokeVoidAsync("chartInterop.createPieChart", "expenseChart",
                labels, data, colors, new { });
        }
    }

    private async Task OnTrendPeriodChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var months))
        {
            trendMonths = months;
            await LoadTrendData();
            await RenderCharts();
        }
    }

    private static string FormatCurrency(decimal value)
    {
        return value.ToString("C0");
    }

    private string GetRestrictedPercentage()
    {
        return $"{(metrics?.RestrictedFundsPercentage ?? 0):N1}%";
    }

    private string GetThresholdPercentage()
    {
        var ytd = metrics?.YtdNetIncome ?? 0;
        return ((ytd / 1_000_000m) * 100).ToString("N1");
    }

    private void ShowQuickAdd()
    {
        showQuickAddModal = true;
    }

    private void CloseQuickAdd()
    {
        showQuickAddModal = false;
    }

    private async Task OnQuickAddSaved()
    {
        showQuickAddModal = false;
        await LoadDashboardData();
        await RenderCharts();
    }
}
