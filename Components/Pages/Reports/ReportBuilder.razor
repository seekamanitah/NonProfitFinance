@page "/reports"
@inject IReportService ReportService
@inject ICategoryService CategoryService
@inject IFundService FundService
@inject IDonorService DonorService
@inject IGrantService GrantService
@inject IPdfExportService PdfExportService
@inject IImportExportService ImportExportService
@inject IReportCustomizationService ReportCustomizationService
@inject IReportPresetService ReportPresetService
@inject IJSRuntime JS
@inject IToastService Toast
@rendermode InteractiveServer

<PageTitle>Reports - NonProfit Finance</PageTitle>

<!-- Report Configuration -->
<div class="card mb-3">
    <div class="card-header">
        <div class="d-flex justify-between align-center">
            <h3 class="card-title"><i class="fas fa-cog"></i> Report Settings</h3>
            <div class="d-flex gap-2">
                <button class="btn btn-outline btn-sm" @onclick="ShowSavePresetDialog">
                    <i class="fas fa-save"></i> Save Preset
                </button>
                <select class="form-control" style="width: 200px;" @onchange="LoadPreset">
                    <option value="">Load Preset...</option>
                    @foreach (var preset in savedPresets)
                    {
                        <option value="@preset.Id">@preset.Name @(preset.IsDefault ? "?" : "")</option>
                    }
                </select>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Date Range Selector -->
        <div class="mb-3">
            <DateRangeSelector 
                StartDate="@startDate"
                EndDate="@endDate"
                ShowComparison="true"
                ShowFiscalYear="true"
                OnRangeChanged="OnDateRangeChanged"
                OnComparisonChanged="OnComparisonChanged" />
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Account</label>
                <select class="form-control" @bind="selectedFundId">
                    <option value="">All Accounts</option>
                    @foreach (var fund in funds)
                    {
                        <option value="@fund.Id">@fund.Name</option>
                    }
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Category</label>
                <select class="form-control" @bind="selectedCategoryId">
                    <option value="">All Categories</option>
                    @foreach (var category in categories)
                    {
                        <option value="@category.Id">@category.Name</option>
                    }
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Donor</label>
                <select class="form-control" @bind="selectedDonorId">
                    <option value="">All Donors</option>
                    @foreach (var donor in donors)
                    {
                        <option value="@donor.Id">@donor.Name</option>
                    }
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Grant</label>
                <select class="form-control" @bind="selectedGrantId">
                    <option value="">All Grants</option>
                    @foreach (var grant in grants)
                    {
                        <option value="@grant.Id">@grant.Name</option>
                    }
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Interval</label>
                <select class="form-control" @bind="trendInterval">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                    <option value="quarterly">Quarterly</option>
                    <option value="yearly">Yearly</option>
                </select>
            </div>
            
            <div class="form-group" style="align-self: flex-end;">
                <button class="btn btn-primary" @onclick="GenerateReport">
                    <i class="fas fa-sync"></i> Generate Report
                </button>
            </div>
        </div>
        
        <!-- Export Options -->
        <div class="d-flex gap-2 mt-3 align-center">
            <div class="dropdown" style="position: relative;">
                <button class="btn btn-outline" 
                        @onclick="ToggleExportMenu" 
                        disabled="@(!hasGeneratedReport)"
                        title="@(hasGeneratedReport ? "Export report in various formats" : "Generate a report first to enable export options")"
                        aria-expanded="@showExportMenu"
                        aria-haspopup="true">
                    <i class="fas fa-download" aria-hidden="true"></i> Export <i class="fas fa-caret-down" aria-hidden="true"></i>
                </button>
                @if (!hasGeneratedReport)
                {
                    <small class="text-muted d-block" style="font-size: 0.75rem; margin-top: 0.25rem;">
                        <i class="fas fa-info-circle" aria-hidden="true"></i> Generate report first
                    </small>
                }
                @if (showExportMenu)
                {
                    <div class="dropdown-menu show" style="position: absolute; z-index: 1000;" role="menu">
                        <button class="dropdown-item" @onclick="ShowPdfExportModal" role="menuitem">
                            <i class="fas fa-file-pdf text-danger" aria-hidden="true"></i> Comprehensive PDF (Configurable)
                        </button>
                        <button class="dropdown-item" @onclick="ExportToExcel" role="menuitem">
                            <i class="fas fa-file-excel text-success" aria-hidden="true"></i> Export to Excel
                        </button>
                        <hr style="margin: 0.5rem 0;" />
                        <button class="dropdown-item" @onclick="ExportTransactionsPdf" role="menuitem">
                            <i class="fas fa-file-pdf text-danger" aria-hidden="true"></i> Transaction Report (PDF)
                        </button>
                        <button class="dropdown-item" @onclick="ExportDonorsPdf" role="menuitem">
                            <i class="fas fa-file-pdf text-danger" aria-hidden="true"></i> Donor Report (PDF)
                        </button>
                        <button class="dropdown-item" @onclick="ExportGrantsPdf" role="menuitem">
                            <i class="fas fa-file-pdf text-danger" aria-hidden="true"></i> Grant Report (PDF)
                        </button>
                        <button class="dropdown-item" @onclick="ExportFundsPdf" role="menuitem">
                            <i class="fas fa-file-pdf text-danger" aria-hidden="true"></i> Fund Summary (PDF)
                        </button>
                        <button class="dropdown-item" @onclick="ExportBudgetPdf" role="menuitem">
                            <i class="fas fa-file-pdf text-danger" aria-hidden="true"></i> Budget vs Actual (PDF)
                        </button>
                    </div>
                }
            </div>
            
            <div class="form-group" style="margin-bottom: 0;">
                <select class="form-control" @bind="selectedTheme" style="width: auto;" aria-label="Report theme">
                    <option value="Modern">Modern Theme</option>
                    <option value="Classic">Classic Theme</option>
                    <option value="FireDepartment">Fire Dept Theme</option>
                    <option value="Dark">Dark Theme</option>
                    <option value="Light">Light Theme</option>
                </select>
            </div>
            
            <button class="btn btn-outline" @onclick="ShowCustomizationModal" title="Customize report columns and export options">
                <i class="fas fa-columns"></i> Customize
            </button>
        </div>
        
        @if (isExporting)
        {
            <div class="alert alert-info mt-2">
                <span class="spinner"></span> Generating export...
            </div>
        }
    </div>
</div>

@if (isLoading)
{
    <SkeletonLoader Type="SkeletonLoader.SkeletonType.MetricCards" Count="4" />
    <div class="mt-3">
        <SkeletonLoader Type="SkeletonLoader.SkeletonType.CardGrid" Count="2" />
    </div>
}
else if (summary != null)
{
    <!-- Summary Cards -->
    <div class="metric-cards">
        <MetricCard 
            Title="Total Income" 
            Value="@summary.TotalIncome.ToString("C2")"
            Icon="fa-arrow-down"
            IconType="income"
            Change="@GetComparisonChange(summary.TotalIncome, comparisonSummary?.TotalIncome)"
            ChangeLabel="@(comparisonEnabled ? "vs prior period" : null)" />
        
        <MetricCard 
            Title="Total Expenses" 
            Value="@summary.TotalExpenses.ToString("C2")"
            Icon="fa-arrow-up"
            IconType="expense"
            Change="@GetComparisonChange(summary.TotalExpenses, comparisonSummary?.TotalExpenses, true)"
            ChangeLabel="@(comparisonEnabled ? "vs prior period" : null)" />
        
        <MetricCard 
            Title="Net Income" 
            Value="@summary.NetIncome.ToString("C2")"
            Icon="fa-balance-scale"
            IconType="@(summary.NetIncome >= 0 ? "income" : "expense")"
            ValueClass="@(summary.NetIncome >= 0 ? "positive" : "negative")"
            Change="@GetComparisonChange(summary.NetIncome, comparisonSummary?.NetIncome)"
            ChangeLabel="@(comparisonEnabled ? "vs prior period" : null)" />
        
        <MetricCard 
            Title="Net Margin" 
            Value="@GetNetMargin()"
            Icon="fa-percentage"
            IconType="neutral" />
    </div>
    
    @if (comparisonEnabled && comparisonSummary != null)
    {
        <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle"></i>
            Comparing to <strong>@comparisonStartDate.ToString("MMM d") - @comparisonEndDate.ToString("MMM d, yyyy")</strong>
        </div>
    }
    
    <!-- Charts -->
    <div class="charts-grid">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Income by Category</h3>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="incomeChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Expenses by Category</h3>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Trend Chart -->
    <div class="card mb-3">
        <div class="card-header">
            <h3 class="card-title">Monthly Trend</h3>
        </div>
        <div class="card-body">
            <div class="chart-container" style="height: 350px;">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Detail Tables -->
    <div class="charts-grid">
        <!-- Income Breakdown -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Income Breakdown</h3>
            </div>
            <div class="card-body" style="padding: 0; overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            @if (IsColumnVisible("Category")) { <th>Category</th> }
                            @if (IsColumnVisible("Amount")) { <th class="text-right">Amount</th> }
                            @if (IsColumnVisible("Percentage")) { <th class="text-right">%</th> }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var cat in summary.IncomeByCategory)
                        {
                            <tr>
                                @if (IsColumnVisible("Category"))
                                {
                                    <td>
                                        <span class="tree-color" style="background: @(cat.Color ?? "#28a745");"></span>
                                        @cat.CategoryName
                                    </td>
                                }
                                @if (IsColumnVisible("Amount")) { <td class="text-right amount income">@cat.Amount.ToString(columnSettings?.CurrencyFormat ?? "C2")</td> }
                                @if (IsColumnVisible("Percentage")) { <td class="text-right">@cat.Percentage.ToString("N1")%</td> }
                            </tr>
                        }
                        <tr style="font-weight: 600; background: var(--bg-primary);">
                            @if (IsColumnVisible("Category")) { <td>Total</td> }
                            @if (IsColumnVisible("Amount")) { <td class="text-right amount income">@summary.TotalIncome.ToString(columnSettings?.CurrencyFormat ?? "C2")</td> }
                            @if (IsColumnVisible("Percentage")) { <td class="text-right">100%</td> }
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Expense Breakdown -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Expense Breakdown</h3>
            </div>
            <div class="card-body" style="padding: 0; overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            @if (IsColumnVisible("Category")) { <th>Category</th> }
                            @if (IsColumnVisible("Amount")) { <th class="text-right">Amount</th> }
                            @if (IsColumnVisible("Percentage")) { <th class="text-right">%</th> }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var cat in summary.ExpensesByCategory)
                        {
                            <tr>
                                @if (IsColumnVisible("Category"))
                                {
                                    <td>
                                        <span class="tree-color" style="background: @(cat.Color ?? "#dc3545");"></span>
                                        @cat.CategoryName
                                    </td>
                                }
                                @if (IsColumnVisible("Amount")) { <td class="text-right amount expense">@cat.Amount.ToString(columnSettings?.CurrencyFormat ?? "C2")</td> }
                                @if (IsColumnVisible("Percentage")) { <td class="text-right">@cat.Percentage.ToString("N1")%</td> }
                            </tr>
                        }
                        <tr style="font-weight: 600; background: var(--bg-primary);">
                            @if (IsColumnVisible("Category")) { <td>Total</td> }
                            @if (IsColumnVisible("Amount")) { <td class="text-right amount expense">@summary.TotalExpenses.ToString(columnSettings?.CurrencyFormat ?? "C2")</td> }
                            @if (IsColumnVisible("Percentage")) { <td class="text-right">100%</td> }
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
}

@if (showPdfExportModal)
{
    <div class="modal-backdrop" @onclick="ClosePdfExportModal">
        <div class="modal" @onclick:stopPropagation="true" style="max-width: 520px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-file-pdf"></i> PDF Export Options</h3>
                <button class="modal-close" @onclick="ClosePdfExportModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Report Title</label>
                    <input type="text" class="form-control" @bind="pdfCustomTitle" placeholder="Financial Report" />
                </div>

                <h4 style="margin-top: 1rem;">Sections to Include</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <label class="d-flex align-center gap-2">
                        <input type="checkbox" @bind="pdfIncludeSummary" /> Financial Summary
                    </label>
                    <label class="d-flex align-center gap-2">
                        <input type="checkbox" @bind="pdfIncludeIncome" /> Income Breakdown
                    </label>
                    <label class="d-flex align-center gap-2">
                        <input type="checkbox" @bind="pdfIncludeExpenses" /> Expense Breakdown
                    </label>
                    <label class="d-flex align-center gap-2">
                        <input type="checkbox" @bind="pdfIncludeTrend" /> Monthly Trend
                    </label>
                    <label class="d-flex align-center gap-2">
                        <input type="checkbox" @bind="pdfIncludeTransactions" /> Transaction Detail
                    </label>
                    <label class="d-flex align-center gap-2">
                        <input type="checkbox" @bind="pdfIncludeDonors" /> Donor Summary
                    </label>
                    <label class="d-flex align-center gap-2">
                        <input type="checkbox" @bind="pdfIncludeGrants" /> Grant Status
                    </label>
                    <label class="d-flex align-center gap-2">
                        <input type="checkbox" @bind="pdfIncludeFunds" /> Fund / Accounts
                    </label>
                    <label class="d-flex align-center gap-2">
                        <input type="checkbox" @bind="pdfIncludeBudget" /> Budget vs Actual
                    </label>
                    <label class="d-flex align-center gap-2">
                        <input type="checkbox" @bind="pdfLandscape" /> Landscape Orientation
                    </label>
                </div>

                <div class="alert alert-info mt-3" style="font-size: 0.85rem;">
                    <i class="fas fa-filter"></i>
                    <strong>Active Filters:</strong>
                    @(selectedFundId.HasValue ? $"Account: {funds.FirstOrDefault(f => f.Id == selectedFundId)?.Name}" : "All Accounts")
                    @(selectedCategoryId.HasValue ? $" | Category: {categories.FirstOrDefault(c => c.Id == selectedCategoryId)?.Name}" : "")
                    @(selectedDonorId.HasValue ? $" | Donor: {donors.FirstOrDefault(d => d.Id == selectedDonorId)?.Name}" : "")
                    @(selectedGrantId.HasValue ? $" | Grant: {grants.FirstOrDefault(g => g.Id == selectedGrantId)?.Name}" : "")
                    <br /><small>Period: @startDate.ToString("MMM d, yyyy") – @endDate.ToString("MMM d, yyyy")</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" @onclick="ClosePdfExportModal">Cancel</button>
                <button class="btn btn-primary" @onclick="ExportConfiguredPdf" disabled="@(!HasAnyPdfSection)">
                    <i class="fas fa-download"></i> Generate PDF
                </button>
            </div>
        </div>
    </div>
}

@if (showSavePresetDialog)
{
    <div class="modal-backdrop" @onclick="CloseSavePresetDialog">
        <div class="modal" @onclick:stopPropagation="true" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Save Report Preset</h3>
                <button class="modal-close" @onclick="CloseSavePresetDialog">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Preset Name *</label>
                    <input type="text" class="form-control" @bind="presetName" placeholder="e.g., Monthly Expense Report" />
                </div>
                <div class="form-group">
                    <label class="d-flex align-center gap-2">
                        <input type="checkbox" @bind="presetIsDefault" />
                        Set as default preset
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" @onclick="CloseSavePresetDialog">Cancel</button>
                <button class="btn btn-primary" @onclick="SavePreset">
                    <i class="fas fa-save"></i> Save Preset
                </button>
            </div>
        </div>
    </div>
}

@if (showCustomizationModal)
{
    <ReportCustomizationModal 
        ReportType="@currentReportType"
        OnApply="ApplyCustomization"
        OnCancel="CloseCustomizationModal" />
}

@code {
private DateTime startDate = new DateTime(DateTime.Today.Year, 1, 1);
private DateTime endDate = DateTime.Today;
private string filterType = "all";
private string trendInterval = "monthly";
private int? selectedFundId;
private int? selectedCategoryId;
private int? selectedDonorId;
private int? selectedGrantId;
private List<FundDto> funds = new();
private List<CategoryDto> categories = new();
private List<DonorDto> donors = new();
private List<GrantDto> grants = new();
private IncomeExpenseSummaryDto? summary;
private IncomeExpenseSummaryDto? comparisonSummary;
private List<TrendDataDto> trendData = new();
private bool isLoading = false;
private bool isExporting = false;
private bool showExportMenu = false;
private bool hasGeneratedReport = false;
private string selectedTheme = "Modern";
private List<ReportPreset> savedPresets = new();
private bool showSavePresetDialog = false;
private string presetName = "";
private bool presetIsDefault = false;

// Comparison mode
private bool comparisonEnabled = false;
private DateTime comparisonStartDate;
private DateTime comparisonEndDate;

// Report customization
private bool showCustomizationModal = false;
private CustomizableReportType currentReportType = CustomizableReportType.IncomeExpenseSummary;
private ReportColumnSettings? columnSettings;
private List<ReportColumnConfig> visibleColumns = new();

// PDF export modal state
private bool showPdfExportModal = false;
private string pdfCustomTitle = "";
private bool pdfIncludeSummary = true;
private bool pdfIncludeIncome = true;
private bool pdfIncludeExpenses = true;
private bool pdfIncludeTrend = true;
private bool pdfIncludeTransactions = false;
private bool pdfIncludeDonors = false;
private bool pdfIncludeGrants = false;
private bool pdfIncludeFunds = false;
private bool pdfIncludeBudget = false;
private bool pdfLandscape = false;

private bool HasAnyPdfSection => pdfIncludeSummary || pdfIncludeIncome || pdfIncludeExpenses
    || pdfIncludeTrend || pdfIncludeTransactions || pdfIncludeDonors || pdfIncludeGrants
    || pdfIncludeFunds || pdfIncludeBudget;

private bool IsColumnVisible(string columnId)
{
    if (!visibleColumns.Any()) return true; // show all if no customization
    var col = visibleColumns.FirstOrDefault(c => c.ColumnId == columnId);
    return col?.IsVisible ?? true;
}

private void ParseColumnSettings()
{
    if (columnSettings != null && !string.IsNullOrEmpty(columnSettings.ColumnsJson) && columnSettings.ColumnsJson != "[]")
    {
        try
        {
            visibleColumns = System.Text.Json.JsonSerializer.Deserialize<List<ReportColumnConfig>>(columnSettings.ColumnsJson) ?? new();
        }
        catch { visibleColumns = new(); }
    }
    else
    {
        visibleColumns = new();
    }
}

protected override async Task OnInitializedAsync()
{
    try
    {
        funds = await FundService.GetAllAsync();
        categories = await CategoryService.GetAllAsync();
        donors = await DonorService.GetAllAsync();
        grants = await GrantService.GetAllAsync(null);
        await LoadSavedPresets();
        columnSettings = await ReportCustomizationService.GetSettingsAsync(currentReportType);
        ParseColumnSettings();
    }
    catch (Exception ex)
    {
        Toast.ShowError($"Failed to load report settings: {ex.Message}");
    }
    await GenerateReport();
}

private async Task OnDateRangeChanged((DateTime Start, DateTime End) range)
{
    startDate = range.Start;
    endDate = range.End;
    await GenerateReport();
}

private async Task OnComparisonChanged((DateTime Start, DateTime End)? comparison)
{
    if (comparison.HasValue)
    {
        comparisonEnabled = true;
        comparisonStartDate = comparison.Value.Start;
        comparisonEndDate = comparison.Value.End;
        await LoadComparisonData();
    }
    else
    {
        comparisonEnabled = false;
        comparisonSummary = null;
    }
    StateHasChanged();
}

private async Task LoadComparisonData()
{
    try
    {
        var filter = new ReportFilterRequest(comparisonStartDate, comparisonEndDate, 
            selectedCategoryId,
            selectedFundId,
            selectedDonorId,
            selectedGrantId);
        comparisonSummary = await ReportService.GetIncomeExpenseSummaryAsync(filter);
    }
    catch (Exception ex)
    {
        Toast.ShowError($"Failed to load comparison data: {ex.Message}");
        comparisonSummary = null;
    }
}

private string? GetComparisonChange(decimal current, decimal? previous, bool invertPositive = false)
{
    if (!comparisonEnabled || previous == null || previous == 0) return null;
    var change = ((current - previous.Value) / Math.Abs(previous.Value)) * 100;
    var isPositive = invertPositive ? change <= 0 : change >= 0;
    var prefix = change >= 0 ? "+" : "";
    return $"{prefix}{change:N1}%";
}



protected override async Task OnAfterRenderAsync(bool firstRender)
{
    if (!isLoading && summary != null)
    {
        await RenderCharts();
    }
}

private void ToggleExportMenu()
{
    showExportMenu = !showExportMenu;
}

private void ShowPdfExportModal()
{
    showExportMenu = false;
    pdfCustomTitle = "";
    pdfIncludeSummary = true;
    pdfIncludeIncome = true;
    pdfIncludeExpenses = true;
    pdfIncludeTrend = true;
    pdfIncludeTransactions = false;
    pdfIncludeDonors = false;
    pdfIncludeGrants = false;
    pdfIncludeFunds = false;
    pdfIncludeBudget = false;
    pdfLandscape = false;
    showPdfExportModal = true;
}

private void ClosePdfExportModal()
{
    showPdfExportModal = false;
}

private async Task ExportConfiguredPdf()
{
    showPdfExportModal = false;
    isExporting = true;
    StateHasChanged();

    try
    {
        var theme = Enum.Parse<ReportTheme>(selectedTheme);
        var request = new ReportRequest(startDate, endDate, ReportType.IncomeStatement, theme, true, true,
            selectedCategoryId, selectedFundId, selectedDonorId, selectedGrantId);
        var options = new PdfReportOptions(
            IncludeSummary: pdfIncludeSummary,
            IncludeIncomeBreakdown: pdfIncludeIncome,
            IncludeExpenseBreakdown: pdfIncludeExpenses,
            IncludeTrend: pdfIncludeTrend,
            IncludeTransactions: pdfIncludeTransactions,
            IncludeDonors: pdfIncludeDonors,
            IncludeGrants: pdfIncludeGrants,
            IncludeBudget: pdfIncludeBudget,
            IncludeFunds: pdfIncludeFunds,
            LandscapeOrientation: pdfLandscape,
            CustomTitle: string.IsNullOrWhiteSpace(pdfCustomTitle) ? null : pdfCustomTitle.Trim()
        );
        var pdfBytes = await PdfExportService.GenerateFinancialReportAsync(request, options);
        await DownloadFile(pdfBytes, $"financial_report_{DateTime.Now:yyyyMMdd}.pdf", "application/pdf");
    }
    catch (Exception ex)
    {
        Toast.ShowError($"Failed to export PDF: {ex.Message}");
    }
    finally
    {
        isExporting = false;
    }
}

private async Task ExportToExcel()
{
    showExportMenu = false;
    isExporting = true;
    StateHasChanged();

    try
    {
        var excelBytes = await ImportExportService.ExportFinancialReportToExcelAsync(startDate, endDate);
        await DownloadFile(excelBytes, $"financial_report_{DateTime.Now:yyyyMMdd}.xlsx", 
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
    }
    catch (Exception ex)
    {
        Toast.ShowError($"Failed to export Excel: {ex.Message}");
    }
    finally
    {
        isExporting = false;
    }
}

private async Task ExportTransactionsPdf()
{
    showExportMenu = false;
    isExporting = true;
    StateHasChanged();

    try
    {
        var theme = Enum.Parse<ReportTheme>(selectedTheme);
        var filter = new TransactionFilterRequest(startDate, endDate, selectedCategoryId, selectedFundId,
            selectedDonorId, selectedGrantId);
        var pdfBytes = await PdfExportService.GenerateTransactionReportAsync(filter, theme);
        await DownloadFile(pdfBytes, $"transactions_{DateTime.Now:yyyyMMdd}.pdf", "application/pdf");
    }
    catch (Exception ex)
    {
        Toast.ShowError($"Failed to export transaction report: {ex.Message}");
    }
    finally
    {
        isExporting = false;
    }
}

private async Task ExportDonorsPdf()
{
    showExportMenu = false;
    isExporting = true;
    StateHasChanged();

    try
    {
        var theme = Enum.Parse<ReportTheme>(selectedTheme);
        var pdfBytes = await PdfExportService.GenerateDonorReportAsync(theme);
        await DownloadFile(pdfBytes, $"donors_{DateTime.Now:yyyyMMdd}.pdf", "application/pdf");
    }
    catch (Exception ex)
    {
        Toast.ShowError($"Failed to export donor report: {ex.Message}");
    }
    finally
    {
        isExporting = false;
    }
}

private async Task ExportGrantsPdf()
{
    showExportMenu = false;
    isExporting = true;
    StateHasChanged();

    try
    {
        var theme = Enum.Parse<ReportTheme>(selectedTheme);
        var pdfBytes = await PdfExportService.GenerateGrantReportAsync(theme);
        await DownloadFile(pdfBytes, $"grants_{DateTime.Now:yyyyMMdd}.pdf", "application/pdf");
    }
    catch (Exception ex)
    {
        Toast.ShowError($"Failed to export grant report: {ex.Message}");
    }
    finally
    {
        isExporting = false;
    }
}

private async Task ExportFundsPdf()
{
    showExportMenu = false;
    isExporting = true;
    StateHasChanged();

    try
    {
        var theme = Enum.Parse<ReportTheme>(selectedTheme);
        var pdfBytes = await PdfExportService.GenerateFundSummaryReportAsync(theme);
        await DownloadFile(pdfBytes, $"funds_{DateTime.Now:yyyyMMdd}.pdf", "application/pdf");
    }
    catch (Exception ex)
    {
        Toast.ShowError($"Failed to export fund report: {ex.Message}");
    }
    finally
    {
        isExporting = false;
    }
}

private async Task ExportBudgetPdf()
{
    showExportMenu = false;
    isExporting = true;
    StateHasChanged();

    try
    {
        var theme = Enum.Parse<ReportTheme>(selectedTheme);
        var pdfBytes = await PdfExportService.GenerateBudgetReportAsync(startDate, endDate, theme);
        await DownloadFile(pdfBytes, $"budget_{DateTime.Now:yyyyMMdd}.pdf", "application/pdf");
    }
    catch (Exception ex)
    {
        Toast.ShowError($"Failed to export budget report: {ex.Message}");
    }
    finally
    {
        isExporting = false;
    }
}

private async Task DownloadFile(byte[] content, string fileName, string contentType)
{
    var base64 = Convert.ToBase64String(content);
    await JS.InvokeVoidAsync("downloadFile", fileName, contentType, base64);
}

private async Task GenerateReport()
{
    isLoading = true;
    hasGeneratedReport = false;
    StateHasChanged();

    try
    {
        var filter = new ReportFilterRequest(startDate, endDate, selectedCategoryId, selectedFundId, selectedDonorId, selectedGrantId);
        summary = await ReportService.GetIncomeExpenseSummaryAsync(filter);
        trendData = await ReportService.GetTrendDataAsync(filter, trendInterval);
        hasGeneratedReport = true;
    }
    catch (Exception ex)
    {
        Toast.ShowError($"Failed to generate report: {ex.Message}");
    }
    finally
    {
        isLoading = false;
    }
}

private async Task RenderCharts()
{
    if (summary == null) return;

    try
    {
        // Income pie chart
        if (summary.IncomeByCategory.Any())
        {
            await JS.InvokeVoidAsync("chartInterop.createPieChart", "incomeChart",
                summary.IncomeByCategory.Select(c => c.CategoryName).ToArray(),
                summary.IncomeByCategory.Select(c => c.Amount).ToArray(),
                summary.IncomeByCategory.Select(c => c.Color ?? "#28a745").ToArray(),
                new { });
        }

        // Expense pie chart
        if (summary.ExpensesByCategory.Any())
        {
            await JS.InvokeVoidAsync("chartInterop.createPieChart", "expenseChart",
                summary.ExpensesByCategory.Select(c => c.CategoryName).ToArray(),
                summary.ExpensesByCategory.Select(c => c.Amount).ToArray(),
                summary.ExpensesByCategory.Select(c => c.Color ?? "#dc3545").ToArray(),
                new { });
        }

        // Trend line chart
        if (trendData.Any())
        {
            await JS.InvokeVoidAsync("chartInterop.createBarChart", "trendChart",
                trendData.Select(t => t.Period.ToString("MMM yy")).ToArray(),
                new[]
                {
                    new { label = "Income", data = trendData.Select(t => t.Income).ToArray(), backgroundColor = "#28a745" },
                    new { label = "Expenses", data = trendData.Select(t => t.Expenses).ToArray(), backgroundColor = "#dc3545" }
                },
                new { });
        }
    }
    catch (JSException)
    {
        // Chart rendering can fail during prerender or disposal — safe to ignore
    }
}

    private string GetNetMargin()
    {
        if (summary == null || summary.TotalIncome == 0) return "0.0%";
        return $"{(summary.NetIncome / summary.TotalIncome * 100):N1}%";
    }

    private async Task LoadSavedPresets()
    {
        savedPresets = await ReportPresetService.GetAllPresetsAsync("Financial");
    }

    private void ShowSavePresetDialog()
    {
        presetName = $"Report {DateTime.Now:MMM d, yyyy}";
        presetIsDefault = false;
        showSavePresetDialog = true;
    }

    private void CloseSavePresetDialog()
    {
        showSavePresetDialog = false;
    }

    private async Task SavePreset()
    {
        if (string.IsNullOrWhiteSpace(presetName))
        {
            Toast.ShowWarning("Please enter a preset name", "Required");
            return;
        }

        var preset = new ReportPreset
        {
            Name = presetName,
            ReportType = "Financial",
            StartDate = startDate,
            EndDate = endDate,
            FilterType = "multi",
            AccountId = selectedFundId,
            CategoryId = selectedCategoryId,
            DonorId = selectedDonorId,
            GrantId = selectedGrantId,
            PdfTheme = selectedTheme,
            IsDefault = presetIsDefault
        };

        await ReportPresetService.SavePresetAsync(preset);
        await LoadSavedPresets();
        
        showSavePresetDialog = false;
        Toast.ShowSuccess($"Preset '{presetName}' saved successfully", "Saved");
        StateHasChanged();
    }

    private async Task LoadPreset(ChangeEventArgs e)
    {
        var presetId = e.Value?.ToString();
        if (string.IsNullOrEmpty(presetId)) return;

        var preset = savedPresets.FirstOrDefault(p => p.Id.ToString() == presetId);
        if (preset == null) return;

        startDate = preset.StartDate ?? DateTime.Today.AddYears(-1);
        endDate = preset.EndDate ?? DateTime.Today;
        filterType = preset.FilterType ?? "all";
        selectedFundId = preset.AccountId;
        selectedCategoryId = preset.CategoryId;
        selectedDonorId = preset.DonorId;
        selectedGrantId = preset.GrantId;
        selectedTheme = preset.PdfTheme ?? "Modern";

        await GenerateReport();
    }
    
    // Report Customization Methods
    private void ShowCustomizationModal()
    {
        showCustomizationModal = true;
        StateHasChanged();
    }
    
    private void CloseCustomizationModal()
    {
        showCustomizationModal = false;
        StateHasChanged();
    }
    
    private async Task ApplyCustomization(ReportColumnSettings settings)
    {
        columnSettings = settings;
        ParseColumnSettings();
        showCustomizationModal = false;
        StateHasChanged();
        
        // Regenerate report with new settings
        await GenerateReport();
    }
}
