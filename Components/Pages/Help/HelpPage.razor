@page "/help"
@page "/help/{Section}"
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Help & Documentation - NonProfit Finance</PageTitle>

<div class="help-container">
    <!-- Sidebar Navigation -->
    <aside class="help-sidebar">
        <div class="help-search">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Search help..." @bind="searchQuery" @bind:event="oninput" />
        </div>
        
        <nav class="help-nav">
            @foreach (var group in helpSections)
            {
                var visibleItems = group.Items.Where(i => MatchesSearch(i.Label)).ToList();
                @if (visibleItems.Any())
                {
                    <div class="help-nav-section">
                        <h4><i class="fas @group.Icon"></i> @group.Title</h4>
                        <ul>
                            @foreach (var item in visibleItems)
                            {
                                <li class="@(Section == item.Key ? "active" : "")">
                                    <a @onclick="() => NavigateTo(item.Key)">@item.Label</a>
                                </li>
                            }
                        </ul>
                    </div>
                }
            }
            @if (!string.IsNullOrWhiteSpace(searchQuery) && !helpSections.Any(g => g.Items.Any(i => MatchesSearch(i.Label))))
            {
                <p class="text-muted" style="padding: 1rem; font-size: 0.9rem;">
                    <i class="fas fa-search"></i> No help topics match "<strong>@searchQuery</strong>"
                </p>
            }
        </nav>
    </aside>
    
    <!-- Main Content -->
    <main class="help-content">
        @switch (Section?.ToLower())
        {
            case "welcome":
            case null:
            case "":
                <HelpWelcome />
                break;
            case "quickstart":
                <HelpQuickStart />
                break;
            case "navigation":
                <HelpNavigation />
                break;
            case "shortcuts":
                <HelpShortcuts />
                break;
            case "transactions":
                <HelpTransactions />
                break;
            case "categories":
                <HelpCategories />
                break;
            case "accounts":
                <HelpAccounts />
                break;
            case "budgets":
                <HelpBudgets />
                break;
            case "recurring":
                <HelpRecurring />
                break;
            case "donors":
                <HelpDonors />
                break;
            case "grants":
                <HelpGrants />
                break;
            case "documents":
                <HelpDocuments />
                break;
            case "dashboard":
                <HelpDashboard />
                break;
            case "reports":
                <HelpReports />
                break;
            case "forms":
                <HelpForms />
                break;
            case "compliance":
                <HelpCompliance />
                break;
            case "form990":
                <HelpForm990 />
                break;
            case "fundaccounting":
                <HelpFundAccounting />
                break;
            case "settings":
                <HelpSettings />
                break;
            case "spellcheck":
                <HelpSpellCheck />
                break;
            case "importexport":
                <HelpImportExport />
                break;
            case "backup":
                <HelpBackup />
                break;
            case "glossary":
                <HelpGlossary />
                break;
            case "workflows":
                <HelpWorkflows />
                break;
            case "faq":
                <HelpFAQ />
                break;
            case "troubleshooting":
                <HelpTroubleshooting />
                break;
            default:
                <HelpWelcome />
                break;
        }
    </main>
</div>

@code {
    [Parameter]
    public string? Section { get; set; }
    
    private string searchQuery = "";
    
    private record HelpItem(string Key, string Label);
    private record HelpGroup(string Title, string Icon, List<HelpItem> Items);
    
    private static readonly List<HelpGroup> helpSections =
    [
        new("Getting Started", "fa-rocket", [
            new("welcome", "Welcome & Overview"),
            new("quickstart", "Quick Start Guide"),
            new("navigation", "Navigating the App"),
            new("shortcuts", "Keyboard Shortcuts")
        ]),
        new("Financial Management", "fa-dollar-sign", [
            new("transactions", "Transactions"),
            new("categories", "Categories"),
            new("accounts", "Accounts (Funds)"),
            new("budgets", "Budgets"),
            new("recurring", "Recurring Transactions")
        ]),
        new("Relationships", "fa-users", [
            new("donors", "Donors"),
            new("grants", "Grants"),
            new("documents", "Documents")
        ]),
        new("Analysis & Reports", "fa-chart-bar", [
            new("dashboard", "Dashboard"),
            new("reports", "Reports"),
            new("forms", "Printable Forms")
        ]),
        new("Compliance", "fa-shield-alt", [
            new("compliance", "Compliance Overview"),
            new("form990", "Form 990"),
            new("fundaccounting", "Fund Accounting")
        ]),
        new("System", "fa-cog", [
            new("settings", "Settings"),
            new("spellcheck", "Spell Check"),
            new("importexport", "Import/Export"),
            new("backup", "Backup & Restore")
        ]),
        new("Reference", "fa-book", [
            new("glossary", "Glossary"),
            new("workflows", "Workflow Examples"),
            new("faq", "FAQ"),
            new("troubleshooting", "Troubleshooting")
        ])
    ];
    
    private bool MatchesSearch(string label)
    {
        if (string.IsNullOrWhiteSpace(searchQuery))
            return true;
        return label.Contains(searchQuery, StringComparison.OrdinalIgnoreCase);
    }
    
    private void NavigateTo(string section)
    {
        Section = section;
        Navigation.NavigateTo($"/help/{section}", forceLoad: false);
    }
}
