@inject IJSRuntime JS
@implements IAsyncDisposable

<div class="chart-container" role="img" aria-label="@GetAccessibleDescription()">
    <canvas id="@ChartId" aria-hidden="true"></canvas>
    
    <!-- Screen reader accessible data table -->
    <div class="sr-only">
        <h4>Chart Data: @(Datasets.FirstOrDefault()?.Label ?? "Line Chart")</h4>
        @if (Labels.Any() && Datasets.Any())
        {
            <table>
                <caption>Data for @(Datasets.FirstOrDefault()?.Label ?? "chart")</caption>
                <thead>
                    <tr>
                        <th>Period</th>
                        @foreach (var dataset in Datasets)
                        {
                            <th>@dataset.Label</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < Labels.Length; i++)
                    {
                        <tr>
                            <td>@Labels[i]</td>
                            @foreach (var dataset in Datasets)
                            {
                                <td>@(i < dataset.Data.Length ? dataset.Data[i].ToString("N2") : "N/A")</td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

@code {
    [Parameter] public string ChartId { get; set; } = $"lineChart_{Guid.NewGuid():N}";
    [Parameter] public string[] Labels { get; set; } = Array.Empty<string>();
    [Parameter] public List<ChartDataset> Datasets { get; set; } = new();
    [Parameter] public bool ShowLegend { get; set; } = true;
    [Parameter] public bool BeginAtZero { get; set; } = true;

    private bool isRendered = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender || !isRendered)
        {
            try
            {
                await RenderChart();
                isRendered = true;
            }
            catch (Microsoft.JSInterop.JSException) { }
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (isRendered && Labels.Any() && Datasets.Any())
        {
            try
            {
                await RenderChart();
            }
            catch (Microsoft.JSInterop.JSException) { }
        }
    }

    private async Task RenderChart()
    {
        if (!Labels.Any() || !Datasets.Any()) return;

        var datasets = Datasets.Select(ds => new
        {
            label = ds.Label,
            data = ds.Data,
            borderColor = ds.BorderColor,
            backgroundColor = ds.BackgroundColor,
            fill = ds.Fill
        }).ToArray();

        await JS.InvokeVoidAsync("chartInterop.createLineChart", ChartId, Labels, datasets, new { });
    }

    private string GetAccessibleDescription()
    {
        if (!Labels.Any() || !Datasets.Any())
            return "Line chart with no data";
        
        var descriptions = new List<string>();
        foreach (var dataset in Datasets)
        {
            if (dataset.Data.Any())
            {
                var min = dataset.Data.Min();
                var max = dataset.Data.Max();
                var avg = dataset.Data.Average();
                descriptions.Add($"{dataset.Label}: ranges from {min:N0} to {max:N0}, average {avg:N0}");
            }
        }
        return $"Line chart showing {string.Join("; ", descriptions)} across {Labels.Length} periods from {Labels.First()} to {Labels.Last()}";
    }

    public async Task UpdateData(string[] labels, List<ChartDataset> datasets)
    {
        Labels = labels;
        Datasets = datasets;
        await RenderChart();
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("chartInterop.destroyChart", ChartId);
        }
        catch (Microsoft.JSInterop.JSException) { }
    }

    public class ChartDataset
    {
        public string Label { get; set; } = "";
        public decimal[] Data { get; set; } = Array.Empty<decimal>();
        public string BorderColor { get; set; } = "#C41E3A";
        public string BackgroundColor { get; set; } = "rgba(196, 30, 58, 0.1)";
        public bool Fill { get; set; } = true;
    }
}
