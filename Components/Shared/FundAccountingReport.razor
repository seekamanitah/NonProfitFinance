@namespace NonProfitFinance.Components.Shared
@inject IFundService FundService
@inject ITransactionService TransactionService
@inject IReportService ReportService

<div class="fund-accounting-report @CssClass">
    <div class="report-header">
        <h3>@Title</h3>
        <div class="report-period">
            @StartDate.ToString("MMM d, yyyy") - @EndDate.ToString("MMM d, yyyy")
        </div>
    </div>

    @if (isLoading)
    {
        <SkeletonLoader Type="SkeletonLoader.SkeletonType.Table" Rows="8" Columns="5" />
    }
    else
    {
        <!-- Fund Summary Table -->
        <div class="card mb-3">
            <div class="card-header">
                <h4 class="card-title">Fund Activity Summary</h4>
            </div>
            <div class="card-body" style="padding: 0; overflow-x: auto;">
                <table class="data-table fund-table">
                    <thead>
                        <tr>
                            <th>Fund/Account</th>
                            <th class="text-right">Beginning Balance</th>
                            <th class="text-right">Income</th>
                            <th class="text-right">Expenses</th>
                            <th class="text-right">Net Change</th>
                            <th class="text-right">Ending Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var fund in fundSummaries)
                        {
                            <tr class="@(fund.IsRestricted ? "restricted-fund" : "")">
                                <td>
                                    <div class="fund-name">
                                        @fund.FundName
                                        @if (fund.IsRestricted)
                                        {
                                            <span class="badge badge-warning ml-1" title="Restricted Fund">R</span>
                                        }
                                    </div>
                                    @if (!string.IsNullOrEmpty(fund.FundType))
                                    {
                                        <div class="fund-type text-muted">@fund.FundType</div>
                                    }
                                </td>
                                <td class="text-right">@fund.BeginningBalance.ToString("C0")</td>
                                <td class="text-right amount income">@fund.TotalIncome.ToString("C0")</td>
                                <td class="text-right amount expense">@fund.TotalExpenses.ToString("C0")</td>
                                <td class="text-right amount @(fund.NetChange >= 0 ? "income" : "expense")">
                                    @(fund.NetChange >= 0 ? "+" : "")@fund.NetChange.ToString("C0")
                                </td>
                                <td class="text-right font-bold">@fund.EndingBalance.ToString("C0")</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr class="totals-row">
                            <td><strong>Total All Funds</strong></td>
                            <td class="text-right"><strong>@totalBeginning.ToString("C0")</strong></td>
                            <td class="text-right amount income"><strong>@totalIncome.ToString("C0")</strong></td>
                            <td class="text-right amount expense"><strong>@totalExpenses.ToString("C0")</strong></td>
                            <td class="text-right amount @(totalNetChange >= 0 ? "income" : "expense")">
                                <strong>@(totalNetChange >= 0 ? "+" : "")@totalNetChange.ToString("C0")</strong>
                            </td>
                            <td class="text-right"><strong>@totalEnding.ToString("C0")</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Restricted vs Unrestricted Summary -->
        <div class="charts-grid">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">Restricted Funds</h4>
                </div>
                <div class="card-body">
                    <div class="summary-stat">
                        <span class="stat-label">Total Restricted</span>
                        <span class="stat-value">@restrictedTotal.ToString("C0")</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-label">Funds Count</span>
                        <span class="stat-value">@restrictedCount</span>
                    </div>
                    <div class="progress-bar mt-2">
                        <div class="progress-fill restricted" style="width: @restrictedPercent%"></div>
                    </div>
                    <div class="text-muted mt-1">@restrictedPercent.ToString("N1")% of total funds</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">Unrestricted Funds</h4>
                </div>
                <div class="card-body">
                    <div class="summary-stat">
                        <span class="stat-label">Total Unrestricted</span>
                        <span class="stat-value">@unrestrictedTotal.ToString("C0")</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-label">Funds Count</span>
                        <span class="stat-value">@unrestrictedCount</span>
                    </div>
                    <div class="progress-bar mt-2">
                        <div class="progress-fill unrestricted" style="width: @unrestrictedPercent%"></div>
                    </div>
                    <div class="text-muted mt-1">@unrestrictedPercent.ToString("N1")% of total funds</div>
                </div>
            </div>
        </div>

        @if (ShowDetails)
        {
            <!-- Fund Details Expandable -->
            <div class="card mt-3">
                <div class="card-header">
                    <h4 class="card-title">Fund Transaction Details</h4>
                </div>
                <div class="card-body" style="padding: 0;">
                    @foreach (var fund in fundSummaries.Where(f => f.Transactions.Any()))
                    {
                        <div class="fund-detail-section">
                            <div class="fund-detail-header" @onclick="() => ToggleFundDetail(fund.FundId)">
                                <i class="fas @(expandedFunds.Contains(fund.FundId) ? "fa-chevron-down" : "fa-chevron-right")"></i>
                                <span>@fund.FundName</span>
                                <span class="transaction-count">@fund.Transactions.Count transactions</span>
                            </div>
                            @if (expandedFunds.Contains(fund.FundId))
                            {
                                <table class="data-table nested-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Category</th>
                                            <th>Description</th>
                                            <th class="text-right">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var tx in fund.Transactions.OrderByDescending(t => t.Date).Take(20))
                                        {
                                            <tr>
                                                <td>@tx.Date.ToString("MMM d")</td>
                                                <td>@tx.CategoryName</td>
                                                <td>@(tx.Description ?? "â€”")</td>
                                                <td class="text-right amount @(tx.Type == TransactionType.Income ? "income" : "expense")">
                                                    @(tx.Type == TransactionType.Income ? "+" : "-")@tx.Amount.ToString("C")
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    }
</div>

<style>
    .fund-accounting-report {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .report-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .report-header h3 {
        margin: 0;
    }

    .report-period {
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    .fund-table .fund-name {
        font-weight: 500;
    }

    .fund-table .fund-type {
        font-size: 0.75rem;
    }

    .restricted-fund {
        background: rgba(245, 158, 11, 0.05);
    }

    .totals-row {
        background: var(--bg-secondary);
        border-top: 2px solid var(--border-color);
    }

    .summary-stat {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-color);
    }

    .summary-stat:last-of-type {
        border-bottom: none;
    }

    .stat-label {
        color: var(--text-muted);
    }

    .stat-value {
        font-size: 1.25rem;
        font-weight: 600;
    }

    .progress-bar {
        height: 8px;
        background: var(--bg-secondary);
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        transition: width 0.3s ease;
    }

    .progress-fill.restricted {
        background: #f59e0b;
    }

    .progress-fill.unrestricted {
        background: #22c55e;
    }

    .fund-detail-section {
        border-bottom: 1px solid var(--border-color);
    }

    .fund-detail-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: background 0.15s ease;
    }

    .fund-detail-header:hover {
        background: var(--bg-secondary);
    }

    .fund-detail-header i {
        color: var(--text-muted);
        width: 1rem;
    }

    .transaction-count {
        margin-left: auto;
        color: var(--text-muted);
        font-size: 0.8125rem;
    }

    .nested-table {
        margin: 0;
        border-radius: 0;
    }

    .nested-table th,
    .nested-table td {
        padding: 0.5rem 1rem;
        font-size: 0.8125rem;
    }

    .font-bold {
        font-weight: 600;
    }
</style>

@code {
    public record FundSummaryData(
        int FundId,
        string FundName,
        string? FundType,
        bool IsRestricted,
        decimal BeginningBalance,
        decimal TotalIncome,
        decimal TotalExpenses,
        decimal NetChange,
        decimal EndingBalance,
        List<TransactionDto> Transactions
    );

    [Parameter] public string Title { get; set; } = "Fund Accounting Report";
    [Parameter] public DateTime StartDate { get; set; } = new DateTime(DateTime.Today.Year, 1, 1);
    [Parameter] public DateTime EndDate { get; set; } = DateTime.Today;
    [Parameter] public bool ShowDetails { get; set; } = true;
    [Parameter] public string? CssClass { get; set; }

    private List<FundSummaryData> fundSummaries = [];
    private HashSet<int> expandedFunds = [];
    private bool isLoading = true;

    private decimal totalBeginning => fundSummaries.Sum(f => f.BeginningBalance);
    private decimal totalIncome => fundSummaries.Sum(f => f.TotalIncome);
    private decimal totalExpenses => fundSummaries.Sum(f => f.TotalExpenses);
    private decimal totalNetChange => fundSummaries.Sum(f => f.NetChange);
    private decimal totalEnding => fundSummaries.Sum(f => f.EndingBalance);

    private decimal restrictedTotal => fundSummaries.Where(f => f.IsRestricted).Sum(f => f.EndingBalance);
    private decimal unrestrictedTotal => fundSummaries.Where(f => !f.IsRestricted).Sum(f => f.EndingBalance);
    private int restrictedCount => fundSummaries.Count(f => f.IsRestricted);
    private int unrestrictedCount => fundSummaries.Count(f => !f.IsRestricted);
    private decimal restrictedPercent => totalEnding == 0 ? 0 : (restrictedTotal / totalEnding) * 100;
    private decimal unrestrictedPercent => totalEnding == 0 ? 0 : (unrestrictedTotal / totalEnding) * 100;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        StateHasChanged();

        var funds = await FundService.GetAllAsync();
        var summaries = new List<FundSummaryData>();

        foreach (var fund in funds)
        {
            // Get transactions for this fund in period
            var filter = new TransactionFilterRequest(StartDate, EndDate, null, fund.Id);
            var result = await TransactionService.GetAllAsync(filter);
            var transactions = result.Items;

            var income = transactions.Where(t => t.Type == TransactionType.Income).Sum(t => t.Amount);
            var expenses = transactions.Where(t => t.Type == TransactionType.Expense).Sum(t => t.Amount);
            var netChange = income - expenses;

            // Calculate beginning balance (balance before start date)
            var beginningFilter = new TransactionFilterRequest(DateTime.MinValue, StartDate.AddDays(-1), null, fund.Id);
            var beginningResult = await TransactionService.GetAllAsync(beginningFilter);
            var beginningIncome = beginningResult.Items.Where(t => t.Type == TransactionType.Income).Sum(t => t.Amount);
            var beginningExpenses = beginningResult.Items.Where(t => t.Type == TransactionType.Expense).Sum(t => t.Amount);
            var beginningBalance = beginningIncome - beginningExpenses;

            summaries.Add(new FundSummaryData(
                fund.Id,
                fund.Name,
                fund.Type.ToString(),
                fund.Type == FundType.Restricted || fund.Type == FundType.TemporarilyRestricted,
                beginningBalance,
                income,
                expenses,
                netChange,
                beginningBalance + netChange,
                transactions
            ));
        }

        fundSummaries = summaries.OrderBy(f => f.FundName).ToList();
        isLoading = false;
        StateHasChanged();
    }

    private void ToggleFundDetail(int fundId)
    {
        if (expandedFunds.Contains(fundId))
            expandedFunds.Remove(fundId);
        else
            expandedFunds.Add(fundId);
    }
}
