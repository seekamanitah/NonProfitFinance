@namespace NonProfitFinance.Components.Shared
@inject IBudgetService BudgetService

<div class="card budget-progress-widget @CssClass">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-chart-bar"></i> Budget Progress
        </h3>
        <div class="d-flex gap-2 align-center">
            <select class="form-control form-control-sm" value="@selectedBudgetId" @onchange="OnBudgetChanged">
                @foreach (var budget in budgets)
                {
                    <option value="@budget.Id">@budget.Name</option>
                }
            </select>
            <a href="/budgets" class="btn btn-sm btn-outline">View All</a>
        </div>
    </div>
    <div class="card-body">
        @if (isLoading)
        {
            <SkeletonLoader Type="SkeletonLoader.SkeletonType.List" Rows="4" />
        }
        else if (selectedBudget == null)
        {
            <div class="empty-state">
                <i class="fas fa-clipboard-list"></i>
                <p>No budgets found. <a href="/budgets">Create a budget</a></p>
            </div>
        }
        else
        {
            <!-- Overall Summary -->
            <div class="budget-summary mb-3">
                <div class="summary-item">
                    <span class="summary-label">Total Budget</span>
                    <span class="summary-value">@selectedBudget.TotalBudget.ToString("C2")</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Spent</span>
                    <span class="summary-value expense">@selectedBudget.TotalSpent.ToString("C2")</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Remaining</span>
                    <span class="summary-value @GetRemainingClass()">@selectedBudget.Remaining.ToString("C2")</span>
                </div>
            </div>

            <!-- Overall Progress Bar -->
            <div class="overall-progress mb-3">
                <div class="progress-header">
                    <span>Overall Progress</span>
                    <span class="@GetOverallClass()">@selectedBudget.PercentageUsed.ToString("N1")%</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill @GetOverallClass()" style="width: @Math.Min(selectedBudget.PercentageUsed, 100)%"></div>
                </div>
            </div>

            <!-- Category Breakdown -->
            <div class="category-breakdown">
                <h5>By Category</h5>
                @foreach (var item in GetTopCategories())
                {
                    var statusClass = GetStatusClass(item.PercentageUsed);
                    
                    <div class="category-item">
                        <div class="category-header">
                            <span class="category-name">@item.CategoryName</span>
                            <span class="category-amounts">
                                <span class="@statusClass">@item.ActualAmount.ToString("C2")</span>
                                <span class="text-muted">/ @item.BudgetAmount.ToString("C2")</span>
                            </span>
                        </div>
                        <div class="progress-bar-container small">
                            <div class="progress-bar-fill @statusClass" style="width: @Math.Min(item.PercentageUsed, 100)%"></div>
                        </div>
                    </div>
                }
            </div>

            @if (HasOverBudgetItems())
            {
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>@GetOverBudgetCount() categories</strong> are over budget
                </div>
            }
        }
    </div>
</div>

<style>
    .budget-progress-widget .empty-state {
        text-align: center;
        padding: 2rem;
        color: var(--text-muted);
    }

    .budget-progress-widget .empty-state i {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .budget-summary {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem;
        background: var(--bg-secondary);
        border-radius: var(--radius);
    }

    .summary-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    .summary-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .summary-value {
        font-size: 1.25rem;
        font-weight: 600;
    }

    .summary-value.expense {
        color: #ef4444;
    }

    .summary-value.remaining {
        color: #22c55e;
    }

    .summary-value.warning {
        color: #f59e0b;
    }

    .summary-value.danger {
        color: #ef4444;
    }

    .overall-progress .progress-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.375rem;
        font-size: 0.875rem;
    }

    .progress-bar-container {
        height: 8px;
        background: var(--bg-secondary);
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    }

    .progress-bar-container.small {
        height: 6px;
    }

    .progress-bar-fill {
        height: 100%;
        transition: width 0.3s ease;
        border-radius: 4px;
    }

    .progress-bar-fill.healthy {
        background: #22c55e;
    }

    .progress-bar-fill.warning {
        background: #f59e0b;
    }

    .progress-bar-fill.danger {
        background: #ef4444;
    }

    .category-breakdown h5 {
        font-size: 0.8125rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.75rem;
    }

    .category-item {
        margin-bottom: 0.75rem;
    }

    .category-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.25rem;
        font-size: 0.875rem;
    }

    .category-name {
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 50%;
    }

    .category-amounts {
        font-size: 0.8125rem;
    }

    .healthy {
        color: #22c55e;
    }

    .warning {
        color: #f59e0b;
    }

    .danger {
        color: #ef4444;
    }
</style>

@code {
    [Parameter] public int? BudgetId { get; set; }
    [Parameter] public int MaxCategories { get; set; } = 5;
    [Parameter] public string? CssClass { get; set; }

    private List<BudgetDto> budgets = [];
    private BudgetDto? selectedBudget;
    private int? selectedBudgetId;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadBudgets();
    }

    private async Task LoadBudgets()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            budgets = await BudgetService.GetAllAsync();
            
            if (BudgetId.HasValue)
            {
                selectedBudgetId = BudgetId.Value;
            }
            else if (budgets.Count > 0)
            {
                // Default to most recent active budget
                var currentYear = DateTime.Today.Year;
                selectedBudgetId = budgets
                    .Where(b => b.FiscalYear == currentYear || b.IsActive)
                    .OrderByDescending(b => b.FiscalYear)
                    .FirstOrDefault()?.Id ?? budgets[0].Id;
            }

            if (selectedBudgetId.HasValue)
            {
                selectedBudget = await BudgetService.GetByIdAsync(selectedBudgetId.Value);
            }
        }
        catch (Exception ex)
        {
            budgets = [];
            selectedBudget = null;
            System.Diagnostics.Debug.WriteLine($"Error loading budgets: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnBudgetChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var id))
        {
            selectedBudgetId = id;
            try
            {
                selectedBudget = await BudgetService.GetByIdAsync(id);
            }
            catch (Exception ex)
            {
                selectedBudget = null;
                System.Diagnostics.Debug.WriteLine($"Error loading budget: {ex.Message}");
            }
            StateHasChanged();
        }
    }

    private IEnumerable<BudgetLineItemDto> GetTopCategories()
    {
        return selectedBudget?.LineItems
            .OrderByDescending(i => i.ActualAmount)
            .Take(MaxCategories) ?? [];
    }

    private string GetOverallClass()
    {
        if (selectedBudget == null) return "healthy";
        return selectedBudget.PercentageUsed switch
        {
            > 100 => "danger",
            > 85 => "warning",
            _ => "healthy"
        };
    }

    private string GetRemainingClass()
    {
        if (selectedBudget == null) return "";
        if (selectedBudget.Remaining < 0) return "danger";
        if (selectedBudget.Remaining < selectedBudget.TotalBudget * 0.15m) return "warning";
        return "remaining";
    }

    private string GetStatusClass(decimal percent)
    {
        return percent switch
        {
            > 100 => "danger",
            > 85 => "warning",
            _ => "healthy"
        };
    }

    private bool HasOverBudgetItems()
    {
        return selectedBudget?.LineItems.Any(i => i.ActualAmount > i.BudgetAmount) ?? false;
    }

    private int GetOverBudgetCount()
    {
        return selectedBudget?.LineItems.Count(i => i.ActualAmount > i.BudgetAmount) ?? 0;
    }
}
