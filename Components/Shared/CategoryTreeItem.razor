@* Recursive tree item component for category display *@

<div class="tree-item @(Category.Id == SelectedId ? "selected" : "") @(Category.IsArchived ? "text-muted" : "")"
     style="padding-left: @(Level * 1.5)rem;"
     @onclick="() => OnSelect.InvokeAsync(Category)"
     @onclick:stopPropagation="true"
     role="treeitem"
     aria-expanded="@(HasChildren ? isExpanded : null)"
     aria-selected="@(Category.Id == SelectedId)">
    
    @if (HasChildren)
    {
        <button class="tree-toggle" 
                @onclick="ToggleExpand" 
                @onclick:stopPropagation="true"
                style="min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center; 
                       background: transparent; border: none; cursor: pointer; padding: 0; margin: -0.5rem 0;"
                aria-label="@(isExpanded ? "Collapse" : "Expand") @Category.Name">
            <i class="fas @(isExpanded ? "fa-chevron-down" : "fa-chevron-right")" aria-hidden="true"></i>
        </button>
    }
    else
    {
        <span class="tree-toggle" style="min-width: 44px;"></span>
    }
    
    <span class="tree-color" style="background: @(Category.Color ?? "#6c757d");" aria-hidden="true"></span>
    
    <span class="tree-name">
        @Category.Name
        @if (Category.IsArchived)
        {
            <span class="badge badge-warning" style="font-size: 0.65rem; margin-left: 0.5rem;">Archived</span>
        }
    </span>
    
    <div class="tree-actions" style="margin-left: auto; display: flex; gap: 0.25rem;" @onclick:stopPropagation="true">
        <button class="btn btn-sm btn-icon btn-outline" 
                @onclick="() => OnAddChild.InvokeAsync(Category)" 
                title="Add subcategory"
                aria-label="Add subcategory to @Category.Name"
                style="min-width: 44px; min-height: 44px;">
            <i class="fas fa-plus" aria-hidden="true"></i>
        </button>
        <button class="btn btn-sm btn-icon btn-outline" 
                @onclick="() => OnEdit.InvokeAsync(Category)" 
                title="Edit @Category.Name"
                aria-label="Edit @Category.Name"
                style="min-width: 44px; min-height: 44px;">
            <i class="fas fa-edit" aria-hidden="true"></i>
        </button>
        @if (!Category.IsArchived)
        {
            <button class="btn btn-sm btn-icon btn-outline" 
                    @onclick="() => OnArchive.InvokeAsync(Category)" 
                    title="Archive @Category.Name"
                    aria-label="Archive @Category.Name"
                    style="min-width: 44px; min-height: 44px;">
                <i class="fas fa-archive" aria-hidden="true"></i>
            </button>
        }
    </div>
</div>

@if (isExpanded && HasChildren)
{
    <div class="tree-children">
        @foreach (var child in Category.Children!)
        {
            <CategoryTreeItem 
                Category="child"
                Level="Level + 1"
                SelectedId="SelectedId"
                OnSelect="OnSelect"
                OnEdit="OnEdit"
                OnArchive="OnArchive"
                OnAddChild="OnAddChild" />
        }
    </div>
}

@code {
    [Parameter] public CategoryDto Category { get; set; } = null!;
    [Parameter] public int Level { get; set; } = 0;
    [Parameter] public int? SelectedId { get; set; }
    [Parameter] public EventCallback<CategoryDto> OnSelect { get; set; }
    [Parameter] public EventCallback<CategoryDto> OnEdit { get; set; }
    [Parameter] public EventCallback<CategoryDto> OnArchive { get; set; }
    [Parameter] public EventCallback<CategoryDto> OnAddChild { get; set; }

    private bool isExpanded = true;
    private bool HasChildren => Category.Children?.Any() == true;

    private void ToggleExpand()
    {
        isExpanded = !isExpanded;
    }
}

<style>
    .tree-item {
        display: flex;
        align-items: center;
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        border-radius: 4px;
        transition: background 0.15s ease;
    }
    
    .tree-item:hover {
        background: var(--bg-primary);
    }
    
    .tree-item:hover .tree-actions {
        opacity: 1;
    }
    
    .tree-item.selected {
        background: rgba(196, 30, 58, 0.1);
    }
    
    .tree-actions {
        display: flex;
        gap: 0.25rem;
        opacity: 0;
        transition: opacity 0.15s ease;
    }
    
    .tree-actions .btn {
        padding: 0.25rem 0.5rem;
    }
</style>
