@rendermode InteractiveServer
@inject ITransactionService TransactionService
@inject IDonorService DonorService
@inject IGrantService GrantService
@inject ICategoryService CategoryService
@inject NavigationManager Navigation

<div class="global-search">
<div class="search-input-wrapper">
    <i class="fas fa-search search-icon" aria-hidden="true"></i>
    <input type="text" 
           class="search-input" 
           placeholder="Search... (↑↓ to navigate, Enter to select)" 
           @bind="searchQuery"
           @bind:event="oninput"
           @onfocus="OnFocus"
           @onblur="OnBlur"
           @onkeydown="HandleKeyDown"
           @onkeydown:preventDefault="@(handleKeyDownPreventDefault)"
           role="combobox"
           aria-expanded="@(showResults && results.Any())"
           aria-controls="search-results-list"
           aria-activedescendant="@(selectedIndex >= 0 ? $"search-result-{selectedIndex}" : "")"
           aria-label="Search transactions, donors, grants" />
    @if (!string.IsNullOrEmpty(searchQuery))
    {
        <button class="search-clear" @onclick="ClearSearch" @onclick:stopPropagation="true" 
                title="Clear search (ESC)" aria-label="Clear search">
            <i class="fas fa-times" aria-hidden="true"></i>
        </button>
    }
    @if (!string.IsNullOrEmpty(searchQuery) && results.Any())
    {
        <button class="search-button" @onclick="() => NavigateToResult(results.First())" 
                title="Go to first result (Enter)" aria-label="Go to first result">
            <i class="fas fa-arrow-right" aria-hidden="true"></i>
        </button>
    }
</div>

@if (showResults && results.Any())
{
    <div class="search-results" id="search-results-list" role="listbox">
        <div class="search-results-header">
            <small class="text-muted">
                <i class="fas fa-info-circle" aria-hidden="true"></i> 
                <kbd>↑</kbd><kbd>↓</kbd> navigate, <kbd>Enter</kbd> select, <kbd>Esc</kbd> close
            </small>
        </div>
        @for (int i = 0; i < Math.Min(results.Count, 10); i++)
        {
            var index = i;
            var result = results[i];
            <div class="search-result-item @(selectedIndex == index ? "selected" : "")" 
                 id="search-result-@index"
                 @onclick="() => NavigateToResult(result)"
                 @onclick:stopPropagation="true"
                 @onmouseenter="() => selectedIndex = index"
                 role="option"
                 aria-selected="@(selectedIndex == index)"
                 tabindex="-1">
                <div class="result-icon">
                    <i class="fas @GetResultIcon(result.Type)" aria-hidden="true"></i>
                </div>
                <div class="result-content">
                    <div class="result-title">@result.Title</div>
                    <div class="result-subtitle">@result.Subtitle</div>
                </div>
                <div class="result-meta">
                    <span class="result-type-badge">@result.Type</span>
                    <i class="fas fa-arrow-right result-arrow" aria-hidden="true"></i>
                </div>
            </div>
        }
        @if (results.Count > 10)
        {
            <div class="search-result-footer">
                <small><i class="fas fa-layer-group" aria-hidden="true"></i> Showing 10 of @results.Count results</small>
            </div>
        }
    </div>
}
    else if (showResults && !string.IsNullOrWhiteSpace(searchQuery) && !results.Any())
    {
        <div class="search-results">
            <div class="search-no-results">
                <i class="fas fa-search" aria-hidden="true"></i>
                <p>No results found for "@searchQuery"</p>
            </div>
        </div>
    }
</div>

@code {
private string _searchQuery = "";
private string searchQuery
{
    get => _searchQuery;
    set
    {
        _searchQuery = value;
        selectedIndex = -1; // Reset selection when query changes
        _ = PerformSearch(); // Trigger search when value changes
    }
}
private List<SearchResult> results = new();
private bool showResults = false;
private System.Timers.Timer? debounceTimer;
private bool handleKeyDownPreventDefault = false;
private int selectedIndex = -1; // -1 means no selection

private async Task OnFocus()
{
    if (!string.IsNullOrWhiteSpace(searchQuery))
    {
        showResults = true;
        await PerformSearch();
    }
}

private void OnBlur()
{
    // Delay hiding to allow click events
    Task.Delay(300).ContinueWith(_ => InvokeAsync(() =>
    {
        showResults = false;
        selectedIndex = -1;
        StateHasChanged();
    }));
}

private void HandleKeyDown(KeyboardEventArgs e)
{
    handleKeyDownPreventDefault = false;
    
    if (!showResults || !results.Any())
    {
        if (e.Key == "Escape")
        {
            ClearSearch();
            handleKeyDownPreventDefault = true;
        }
        return;
    }
    
    var maxIndex = Math.Min(results.Count, 10) - 1;
    
    switch (e.Key)
    {
        case "ArrowDown":
            selectedIndex = selectedIndex < maxIndex ? selectedIndex + 1 : 0;
            handleKeyDownPreventDefault = true;
            break;
            
        case "ArrowUp":
            selectedIndex = selectedIndex > 0 ? selectedIndex - 1 : maxIndex;
            handleKeyDownPreventDefault = true;
            break;
            
        case "Enter":
            if (selectedIndex >= 0 && selectedIndex < results.Count)
            {
                NavigateToResult(results[selectedIndex]);
            }
            else if (results.Any())
            {
                NavigateToResult(results.First());
            }
            handleKeyDownPreventDefault = true;
            break;
            
        case "Escape":
            ClearSearch();
            handleKeyDownPreventDefault = true;
            break;
            
        case "Tab":
            showResults = false;
            selectedIndex = -1;
            break;
    }
}

private async Task PerformSearch()
{
    if (string.IsNullOrWhiteSpace(searchQuery))
    {
        results.Clear();
        showResults = false;
        StateHasChanged();
        return;
    }

    showResults = true;
    StateHasChanged();

    debounceTimer?.Stop();
    debounceTimer?.Dispose();

    debounceTimer = new System.Timers.Timer(300);
    debounceTimer.Elapsed += async (sender, args) =>
    {
        debounceTimer?.Stop();
        await InvokeAsync(async () =>
        {
            await SearchAll(searchQuery);
            StateHasChanged();
        });
    };
    debounceTimer.Start();
}

    private async Task SearchAll(string query)
    {
        results.Clear();
        var lowerQuery = query.ToLower();

        // Search Transactions
        var transactions = await TransactionService.GetAllAsync(new DTOs.TransactionFilterRequest(
            DateTime.Today.AddYears(-2), 
            DateTime.Today
        ));

        foreach (var tx in transactions.Items.Where(t => 
            (t.Description != null && t.Description.ToLower().Contains(lowerQuery)) ||
            (t.Payee != null && t.Payee.ToLower().Contains(lowerQuery)) ||
            (t.CategoryName != null && t.CategoryName.ToLower().Contains(lowerQuery))
        ).Take(5))
        {
            results.Add(new SearchResult
            {
                Type = "Transaction",
                Title = tx.Description ?? "Transaction",
                Subtitle = $"{tx.Date:MMM d, yyyy} • {tx.Amount:C} • {tx.CategoryName}",
                Url = $"/transactions?id={tx.Id}"
            });
        }

        // Search Donors
        var donors = await DonorService.GetAllAsync();
        foreach (var donor in donors.Where(d => d.Name.ToLower().Contains(lowerQuery)).Take(5))
        {
            results.Add(new SearchResult
            {
                Type = "Donor",
                Title = donor.Name,
                Subtitle = $"{donor.Type} • {donor.TotalContributions:C} contributed",
                Url = $"/donors?id={donor.Id}"
            });
        }

        // Search Grants
        var grants = await GrantService.GetAllAsync(null);
        foreach (var grant in grants.Where(g => 
            g.Name.ToLower().Contains(lowerQuery) || 
            (g.GrantorName != null && g.GrantorName.ToLower().Contains(lowerQuery))
        ).Take(5))
        {
            results.Add(new SearchResult
            {
                Type = "Grant",
                Title = grant.Name,
                Subtitle = $"{grant.GrantorName} • {grant.Amount:C} • {grant.Status}",
                Url = $"/grants?id={grant.Id}"
            });
        }

        // Search Categories
        var categories = await CategoryService.GetAllAsync();
        foreach (var cat in categories.Where(c => c.Name.ToLower().Contains(lowerQuery)).Take(3))
        {
            results.Add(new SearchResult
            {
                Type = "Category",
                Title = cat.Name,
                Subtitle = $"{cat.Type} category",
                Url = $"/categories?id={cat.Id}"
            });
        }

        results = results.OrderBy(r => r.Type).ToList();
    }

    private void ClearSearch()
    {
        searchQuery = "";
        results.Clear();
        showResults = false;
        selectedIndex = -1;
        StateHasChanged();
    }

    private void NavigateToResult(SearchResult result)
    {
        Navigation.NavigateTo(result.Url);
        ClearSearch();
    }

    private string GetResultIcon(string type) => type switch
    {
        "Transaction" => "fa-receipt",
        "Donor" => "fa-heart",
        "Grant" => "fa-hand-holding-usd",
        "Category" => "fa-tags",
        _ => "fa-file"
    };

    private class SearchResult
    {
        public string Type { get; set; } = "";
        public string Title { get; set; } = "";
        public string Subtitle { get; set; } = "";
        public string Url { get; set; } = "";
    }
}
