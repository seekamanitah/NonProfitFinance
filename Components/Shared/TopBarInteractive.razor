@inject IJSRuntime JS
@implements IAsyncDisposable

<div class="sidebar-actions">
    <button class="btn-sidebar-action btn-quick-add" @onclick="ShowQuickAdd" title="Quick Add Transaction">
        <i class="fas fa-plus"></i>
        <span>Quick Add</span>
    </button>
    
    <button class="btn-sidebar-action" @onclick="ToggleTheme" title="Toggle Theme">
        <i class="fas @(currentTheme == "dark" ? "fa-sun" : "fa-moon")"></i>
        <span>@(currentTheme == "dark" ? "Light" : "Dark") Mode</span>
    </button>
</div>

@if (showQuickAddModal)
{
    <QuickAddModal OnClose="CloseQuickAdd" OnSaved="OnTransactionSaved" />
}

@code {
    [Parameter]
    public EventCallback OnQuickAddSaved { get; set; }

    private bool showQuickAddModal = false;
    private string currentTheme = "light";
    private IJSObjectReference? themeModule;
    private DotNetObjectReference<TopBarInteractive>? dotNetReference;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Create reference to this component for JS callbacks
                dotNetReference = DotNetObjectReference.Create(this);
                
                // Get current theme
                currentTheme = await JS.InvokeAsync<string>("themeManager.getTheme");
                StateHasChanged();
                
                // Set up event listener using custom event
                themeModule = await JS.InvokeAsync<IJSObjectReference>("import", "./js/theme-listener.js");
                await themeModule.InvokeVoidAsync("setupThemeListener", dotNetReference);
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Theme initialization error: {ex.Message}");
                currentTheme = "light";
            }
        }
    }

    [JSInvokable]
    public void OnThemeChanged(string newTheme)
    {
        currentTheme = newTheme;
        InvokeAsync(StateHasChanged);
    }

    private void ShowQuickAdd()
    {
        showQuickAddModal = true;
    }

    private void CloseQuickAdd()
    {
        showQuickAddModal = false;
    }

    private async Task ToggleTheme()
    {
        try
        {
            // Optimistically update UI first for immediate feedback
            var previousTheme = currentTheme;
            currentTheme = currentTheme == "dark" ? "light" : "dark";
            StateHasChanged();
            
            // Then sync with JS
            var actualTheme = await JS.InvokeAsync<string>("themeManager.toggle");
            
            // Ensure we're in sync with actual theme
            if (actualTheme != currentTheme)
            {
                currentTheme = actualTheme;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Theme toggle error: {ex.Message}");
            // Revert on error
            currentTheme = currentTheme == "dark" ? "light" : "dark";
            StateHasChanged();
        }
    }

    private async Task OnTransactionSaved()
    {
        showQuickAddModal = false;
        await OnQuickAddSaved.InvokeAsync();
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        try
        {
            if (themeModule is not null)
            {
                await themeModule.DisposeAsync();
            }
            
            dotNetReference?.Dispose();
        }
        catch (Microsoft.JSInterop.JSException)
        {
            // Ignore JS disposal errors during disconnect
        }
    }
}
