@inject IJSRuntime JS
@implements IAsyncDisposable

<div class="sidebar-actions">
    <button class="btn-sidebar-action btn-quick-add" @onclick="ShowQuickAdd" title="Quick Add Transaction">
        <i class="fas fa-plus"></i>
        <span>Quick Add</span>
    </button>
    
    <button class="btn-sidebar-action" @onclick="ToggleTheme" title="Toggle Theme">
        <i class="fas @(currentTheme == "dark" ? "fa-sun" : "fa-moon")"></i>
        <span>@(currentTheme == "dark" ? "Light" : "Dark") Mode</span>
    </button>
</div>

@if (showQuickAddModal)
{
    <QuickAddModal OnClose="CloseQuickAdd" OnSaved="OnTransactionSaved" />
}

@code {
    [Parameter]
    public EventCallback OnQuickAddSaved { get; set; }

    private bool showQuickAddModal = false;
    private string currentTheme = "light";
    private IJSObjectReference? module;
    private IJSObjectReference? themeListener;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Try to get theme with timeout
                var timeoutTask = Task.Delay(500);
                var getThemeTask = JS.InvokeAsync<string>("themeManager.getTheme").AsTask();
                
                var completedTask = await Task.WhenAny(getThemeTask, timeoutTask);
                
                if (completedTask == getThemeTask)
                {
                    currentTheme = getThemeTask.Result;
                }
                else
                {
                    // Fallback to light theme if timeout
                    currentTheme = "light";
                }
                
                StateHasChanged();
                
                // Set up event listener for theme changes from other components
                await SetupThemeListener();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Theme initialization error: {ex.Message}");
                currentTheme = "light";
            }
        }
    }

    private async Task SetupThemeListener()
    {
        try
        {
            // Register Blazor callback with JavaScript theme manager
            await JS.InvokeVoidAsync("themeManager.onThemeChange", new Action<string>(OnThemeChangedFromJS));
        }
        catch
        {
            // Event listener setup is optional
        }
    }

    private void OnThemeChangedFromJS(string newTheme)
    {
        currentTheme = newTheme;
        StateHasChanged();
    }

    private void ShowQuickAdd()
    {
        showQuickAddModal = true;
    }

    private void CloseQuickAdd()
    {
        showQuickAddModal = false;
    }

    private async Task ToggleTheme()
    {
        try
        {
            currentTheme = await JS.InvokeAsync<string>("themeManager.toggle");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Theme toggle error: {ex.Message}");
        }
    }

    private async Task OnTransactionSaved()
    {
        showQuickAddModal = false;
        await OnQuickAddSaved.InvokeAsync();
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        try
        {
            if (module is not null)
            {
                await module.DisposeAsync();
            }
        }
        catch
        {
            // Ignore disposal errors
        }
    }
}
