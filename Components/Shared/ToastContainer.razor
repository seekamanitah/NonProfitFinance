@implements IDisposable
@inject IToastService ToastService

<div class="toast-container" aria-live="polite" aria-label="Notifications">
    @foreach (var toast in toasts)
    {
        <div class="toast @toast.ColorClass @(IsExpiring(toast) ? "exiting" : "")" 
             role="alert"
             @key="toast.Id">
            <div class="toast-icon">
                <i class="fas @toast.Icon"></i>
            </div>
            <div class="toast-content">
                <div class="toast-title">@toast.Title</div>
                <div class="toast-message">@toast.Message</div>
            </div>
            <button class="toast-close" @onclick="() => RemoveToast(toast.Id)" aria-label="Dismiss notification">
                <i class="fas fa-times"></i>
            </button>
            <div class="toast-progress" style="animation-duration: @(toast.Duration)ms;"></div>
        </div>
    }
</div>

<style>
    .toast-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        max-width: 400px;
        width: calc(100% - 2rem);
        pointer-events: none;
    }
    
    .toast {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 1rem;
        background: var(--bg-primary, white);
        border-radius: 0.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border-left: 4px solid;
        animation: slideIn 0.3s ease;
        pointer-events: all;
        position: relative;
        overflow: hidden;
    }
    
    .toast.exiting {
        animation: slideOut 0.3s ease forwards;
    }
    
    @@keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @@keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    .toast-success {
        border-color: #10b981;
    }
    
    .toast-success .toast-icon {
        color: #10b981;
    }
    
    .toast-error {
        border-color: #ef4444;
    }
    
    .toast-error .toast-icon {
        color: #ef4444;
    }
    
    .toast-warning {
        border-color: #f59e0b;
    }
    
    .toast-warning .toast-icon {
        color: #f59e0b;
    }
    
    .toast-info {
        border-color: #3b82f6;
    }
    
    .toast-info .toast-icon {
        color: #3b82f6;
    }
    
    .toast-icon {
        font-size: 1.25rem;
        flex-shrink: 0;
        padding-top: 0.125rem;
    }
    
    .toast-content {
        flex: 1;
        min-width: 0;
    }
    
    .toast-title {
        font-weight: 600;
        color: var(--text-primary, #1f2937);
        margin-bottom: 0.25rem;
    }
    
    .toast-message {
        font-size: 0.875rem;
        color: var(--text-secondary, #6b7280);
        word-wrap: break-word;
    }
    
    .toast-close {
        background: none;
        border: none;
        color: var(--text-muted, #9ca3af);
        cursor: pointer;
        padding: 0.25rem;
        flex-shrink: 0;
        transition: color 0.15s;
    }
    
    .toast-close:hover {
        color: var(--text-primary, #1f2937);
    }
    
    .toast-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: currentColor;
        opacity: 0.3;
        animation: progress linear forwards;
    }
    
    @@keyframes progress {
        from { transform: scaleX(1); }
        to { transform: scaleX(0); }
    }
    
    .toast-success .toast-progress { background: #10b981; }
    .toast-error .toast-progress { background: #ef4444; }
    .toast-warning .toast-progress { background: #f59e0b; }
    .toast-info .toast-progress { background: #3b82f6; }
    
    /* Dark mode */
    :root[data-theme="dark"] .toast {
        background: var(--bg-secondary, #1f2937);
    }
    
    /* Mobile positioning */
    @@media (max-width: 480px) {
        .toast-container {
            top: auto;
            bottom: 1rem;
            left: 1rem;
            right: 1rem;
        }
        
        .toast {
            width: 100%;
        }
    }
</style>

@code {
    private List<ToastMessage> toasts = [];
    private HashSet<Guid> expiringToasts = [];
    private Dictionary<Guid, Timer> timers = [];
    
    protected override void OnInitialized()
    {
        ToastService.OnShow += ShowToast;
        ToastService.OnRemove += HandleRemove;
    }
    
    private void ShowToast(ToastMessage toast)
    {
        InvokeAsync(() =>
        {
            toasts.Add(toast);
            StateHasChanged();
            
            // Set up auto-dismiss timer
            if (toast.Duration > 0)
            {
                var timer = new Timer(_ =>
                {
                    InvokeAsync(() => StartRemoveToast(toast.Id));
                }, null, toast.Duration, Timeout.Infinite);
                
                timers[toast.Id] = timer;
            }
        });
    }
    
    private void HandleRemove(Guid id)
    {
        InvokeAsync(() =>
        {
            if (id == Guid.Empty)
            {
                // Clear all
                foreach (var t in toasts.ToList())
                {
                    RemoveToast(t.Id);
                }
            }
            else
            {
                RemoveToast(id);
            }
        });
    }
    
    private void StartRemoveToast(Guid id)
    {
        if (!toasts.Any(t => t.Id == id)) return;
        
        expiringToasts.Add(id);
        StateHasChanged();
        
        // Wait for exit animation
        _ = Task.Delay(280).ContinueWith(_ => 
        {
            InvokeAsync(() => 
            {
                toasts.RemoveAll(t => t.Id == id);
                expiringToasts.Remove(id);
                if (timers.TryGetValue(id, out var timer))
                {
                    timer.Dispose();
                    timers.Remove(id);
                }
                StateHasChanged();
            });
        });
    }
    
    private void RemoveToast(Guid id)
    {
        StartRemoveToast(id);
    }
    
    private bool IsExpiring(ToastMessage toast) => expiringToasts.Contains(toast.Id);
    
    public void Dispose()
    {
        ToastService.OnShow -= ShowToast;
        ToastService.OnRemove -= HandleRemove;
        
        foreach (var timer in timers.Values)
        {
            timer.Dispose();
        }
        timers.Clear();
    }
}
