@inherits LayoutComponentBase
@implements IDisposable
@inject IKeyboardShortcutService KeyboardShortcuts
@inject ISpellCheckService SpellCheck
@inject IJSRuntime JS
@inject NavigationManager Navigation

<!-- Skip Link for Accessibility -->
<a href="#main-content" class="skip-link" aria-label="Skip to main content">
    Skip to main content
</a>

<!-- Mobile overlay for sidebar -->
@if (mobileMenuOpen)
{
    <div class="sidebar-overlay" @onclick="CloseMobileMenu"></div>
}

<div class="app-container @(mobileMenuOpen ? "mobile-menu-open" : "")">
    <aside class="sidebar @(sidebarCollapsed ? "collapsed" : "") @(mobileMenuOpen ? "mobile-open" : "")" aria-label="Navigation sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fas fa-fire-extinguisher" aria-hidden="true"></i>
            </div>
            <span class="sidebar-title">NonProfit Finance</span>
            <button class="btn-collapse-sidebar d-desktop-only" @onclick="ToggleSidebar" aria-label="@(sidebarCollapsed ? "Expand sidebar" : "Collapse sidebar")" title="@(sidebarCollapsed ? "Expand" : "Collapse")">
                <i class="fas @(sidebarCollapsed ? "fa-chevron-right" : "fa-chevron-left")" aria-hidden="true"></i>
            </button>
            <button class="btn-close-mobile d-mobile-only" @onclick="CloseMobileMenu" aria-label="Close menu">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <NavMenu OnNavigate="CloseMobileMenu" />
    </aside>
    
    <div class="main-content">
        <div class="main-header" role="banner">
            <button class="btn btn-icon btn-hamburger d-mobile-only" @onclick="ToggleMobileMenu" aria-label="Toggle navigation menu">
                <i class="fas fa-bars"></i>
            </button>
            <GlobalSearch />
            <div class="header-actions">
                <button class="btn btn-icon" @onclick="ToggleTheme" title="Toggle Theme" aria-label="Toggle dark/light theme">
                    <i class="fas @(currentTheme == "dark" ? "fa-sun" : "fa-moon")" aria-hidden="true"></i>
                </button>
                <button class="btn btn-icon d-desktop-only" @onclick="ShowKeyboardHelp" title="Keyboard Shortcuts (Shift+?)" aria-label="Show keyboard shortcuts">
                    <i class="fas fa-keyboard" aria-hidden="true"></i>
                </button>
            </div>
        </div>
        <main class="page-content" id="main-content" role="main" tabindex="-1">
            @Body
        </main>
    </div>
</div>

<!-- Toast notifications -->
<ToastContainer />

@if (showKeyboardHelp)
{
    <KeyboardShortcutsHelp Show="@showKeyboardHelp" OnClose="CloseKeyboardHelp" />
}

<style>
    /* Mobile responsive styles */
    .d-mobile-only { display: none; }
    .d-desktop-only { display: inline-flex; }
    
    .sidebar-overlay {
        display: none;
    }
    
    .btn-close-mobile {
        background: none;
        border: none;
        color: var(--text-secondary);
        padding: 0.5rem;
        cursor: pointer;
        margin-left: auto;
    }
    
    .btn-collapse-sidebar {
        background: none;
        border: none;
        color: var(--text-secondary);
        padding: 0.25rem 0.5rem;
        cursor: pointer;
        margin-left: auto;
        border-radius: 4px;
        transition: background 0.2s;
    }
    
    .btn-collapse-sidebar:hover {
        background: rgba(255, 255, 255, 0.1);
    }
    
    .btn-hamburger {
        margin-right: 0.5rem;
    }
    
    .header-actions {
        display: flex;
        gap: 0.25rem;
        align-items: center;
    }
    
    @@media (max-width: 768px) {
        .d-mobile-only { display: inline-flex; }
        .d-desktop-only { display: none; }
        
        .sidebar {
            position: fixed;
            left: -280px;
            top: 0;
            bottom: 0;
            z-index: 1001;
            transition: left 0.3s ease;
            box-shadow: none;
        }
        
        .sidebar.mobile-open {
            left: 0;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
        }
        
        .sidebar-overlay {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.2s ease;
        }
        
        .main-content {
            margin-left: 0 !important;
            width: 100% !important;
        }
        
        .main-header {
            padding: 0.75rem 1rem;
        }
        
        .page-content {
            padding: 1rem;
        }
        
        .sidebar-header {
            display: flex;
            align-items: center;
        }
    }
    
    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
</style>

@code {
private bool sidebarCollapsed = false;
private bool mobileMenuOpen = false;
private bool showKeyboardHelp = false;
private string currentTheme = "light";

protected override void OnInitialized()
{
    // Subscribe to location changes
    Navigation.LocationChanged += OnLocationChanged;
}

private void ToggleMobileMenu()
{
    mobileMenuOpen = !mobileMenuOpen;
}

private async Task ToggleSidebar()
{
    sidebarCollapsed = !sidebarCollapsed;
    try
    {
        await JS.InvokeVoidAsync("localStorage.setItem", "sidebarCollapsed", sidebarCollapsed.ToString().ToLower());
    }
    catch { }
}

private void CloseMobileMenu()
{
    mobileMenuOpen = false;
}

private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
{
    // Re-apply theme on navigation - use reapply to ensure it always applies
    try
    {
        currentTheme = await JS.InvokeAsync<string>("themeManager.reapply");
        await InvokeAsync(StateHasChanged);
    }
    catch
    {
        // Theme manager not available
    }
}

protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Initialize theme manager and get current theme
                await JS.InvokeVoidAsync("themeManager.init");
                currentTheme = await JS.InvokeAsync<string>("themeManager.getTheme");
                
                // Restore sidebar collapsed state from localStorage
                var savedCollapsed = await JS.InvokeAsync<string?>("localStorage.getItem", "sidebarCollapsed");
                if (savedCollapsed == "true")
                {
                    sidebarCollapsed = true;
                }
                StateHasChanged();
                
                // Initialize keyboard shortcuts
                await KeyboardShortcuts.InitializeAsync();
                
                // Initialize spell check
                await SpellCheck.InitializeAsync();
                
                // Register global shortcuts
                KeyboardShortcuts.RegisterShortcut("ctrl+n", async () =>
                {
                    await JS.InvokeVoidAsync("eval", "document.querySelector('.btn-quick-add')?.click()");
                });
                
                KeyboardShortcuts.RegisterShortcut("ctrl+f", async () =>
                {
                    await JS.InvokeVoidAsync("eval", "document.querySelector('.search-input')?.focus()");
                });
                
                KeyboardShortcuts.RegisterShortcut("shift+?", async () =>
                {
                    showKeyboardHelp = true;
                    await InvokeAsync(StateHasChanged);
                });
                
                KeyboardShortcuts.RegisterShortcut("escape", async () =>
                {
                    if (showKeyboardHelp)
                    {
                        showKeyboardHelp = false;
                        await InvokeAsync(StateHasChanged);
                    }
                });
            }
            catch
            {
                // Initialization failed - not critical
            }
        }
    }

    private void ShowKeyboardHelp()
    {
        showKeyboardHelp = true;
    }

    private void CloseKeyboardHelp()
    {
        showKeyboardHelp = false;
    }

    private async Task ToggleTheme()
    {
        try
        {
            // Optimistically update UI first for immediate feedback
            currentTheme = currentTheme == "dark" ? "light" : "dark";
            StateHasChanged();
            
            // Then sync with JS
            var actualTheme = await JS.InvokeAsync<string>("themeManager.toggle");
            
            // Ensure we're in sync with actual theme
            if (actualTheme != currentTheme)
            {
                currentTheme = actualTheme;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Theme toggle error: {ex.Message}");
            // Already toggled optimistically, so leave as is
        }
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}

